<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üîç Forense | Auditoria Cient√≠fica de Decis√µes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/legacy/build/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/legacy/build/pdf.worker.min.js';</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; padding-bottom: 80px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <header class="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-50 border-b-4 border-slate-700">
        <h1 class="text-lg font-bold tracking-tight">üîç Forense</h1>
        <p class="text-[11px] text-slate-400 font-medium uppercase tracking-widest">Auditoria Cient√≠fica e Rastreabilidade</p>
    </header>

    <main class="p-4">

        <section id="tab-analisar" class="tab-content active">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-4">
                <h2 class="font-semibold text-slate-800 mb-2">Acervo Documental da Auditoria</h2>
                <p class="text-xs text-slate-500 mb-5 leading-relaxed">
                    Classifique e carregue os documentos que comp√µem esta decis√£o. O Forense agrupar√° of√≠cios e votos como <strong>"Tese Oficial"</strong>, e artigos ou manifestos como <strong>"Contraponto/Contexto"</strong>.
                </p>
                
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                    <div class="mb-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Classifica√ß√£o do Documento:</label>
                        <select id="doc-classificacao" class="w-full text-sm p-2 border border-slate-300 rounded-md bg-white text-slate-700 focus:outline-none focus:border-slate-500">
                            <optgroup label="Documentos Oficiais (Tese)">
                                <option value="oficial_voto">Voto de Diretoria</option>
                                <option value="oficial_memorando">Memorando / Portaria</option>
                                <option value="oficial_oficio">Of√≠cio</option>
                            </optgroup>
                            <optgroup label="Contexto e Contraponto (Ant√≠tese)">
                                <option value="critica_abaixoassinado">Abaixo-assinado / Manifesto</option>
                                <option value="critica_artigo">Artigo T√©cnico / Estudo</option>
                                <option value="critica_publicidade">Publicidade / Mat√©ria</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Arquivo (PDF ou TXT):</label>
                        <input type="file" id="doc-arquivo" accept=".pdf,.txt" class="block w-full text-sm text-slate-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-bold file:bg-slate-200 file:text-slate-700 hover:file:bg-slate-300 cursor-pointer">
                    </div>
                    
                    <button onclick="adicionarDocumento()" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 rounded-md hover:bg-slate-300 transition text-xs uppercase tracking-wide">
                        + Adicionar ao Dossi√™
                    </button>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-700 uppercase border-b border-slate-200 pb-1 mb-2">Documentos em Mem√≥ria</h3>
                    <ul id="lista-documentos" class="space-y-2 empty:after:content-['Nenhum_documento_carregado.'] empty:after:text-xs empty:after:text-slate-400"></ul>
                </div>

                <button onclick="processarDossie()" id="btn-processar" class="w-full bg-slate-800 text-white font-semibold py-3 rounded-lg shadow-sm hover:bg-slate-900 transition flex justify-center items-center text-sm uppercase tracking-wide">
                    Executar Auditoria Cient√≠fica
                </button>
                
                <div id="loading-indicator" class="hidden text-center mt-3 text-xs text-slate-600 font-medium animate-pulse uppercase tracking-widest">
                    Processando Acervo Documental...
                </div>
            </div>
        </section>

        <section id="tab-relatorio" class="tab-content">
            <div id="resultado-vazio" class="text-center text-slate-500 py-10">
                <p class="text-sm">Aguardando processamento documental.</p>
            </div>
            
            <div id="resultado-preenchido" class="hidden space-y-4">
                
                <div class="bg-white p-5 rounded-xl border-l-4 border-slate-800 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Estrutura L√≥gica da Decis√£o</h2>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-mono">M√©todo de Toulmin</span>
                    </div>
                    <p class="text-[11px] text-slate-500 mb-3 border-b border-slate-100 pb-2">O modelo de Toulmin desconstr√≥i o texto identificando a "Alega√ß√£o Central" (a a√ß√£o diretiva imposta) e as suas "Garantias" jur√≠dicas e institucionais.</p>
                    
                    <h3 class="font-semibold text-sm text-slate-800 mb-1">Alternativas Impostas (Alega√ß√£o):</h3>
                    <ul id="lista-alternativas" class="list-disc list-inside text-sm text-slate-700 mb-3 space-y-1"></ul>
                </div>

                <div class="bg-white p-5 rounded-xl border-l-4 border-blue-600 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xs font-bold text-blue-600 uppercase tracking-widest">Infer√™ncia de Prioridades</h2>
                        <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded font-mono">An√°lise de Conte√∫do (Bardin)</span>
                    </div>
                    <p class="text-[11px] text-slate-500 mb-3 border-b border-slate-100 pb-2">A An√°lise de Conte√∫do de Laurence Bardin rastreia a frequ√™ncia e a coocorr√™ncia sem√¢ntica das palavras para inferir o peso qualitativo atribu√≠do pelo decisor a cada crit√©rio.</p>
                    
                    <h3 class="font-semibold text-sm text-slate-800 mb-1">Crit√©rios-Matriz Extra√≠dos:</h3>
                    <div id="tags-criterios" class="flex flex-col gap-2 mt-2"></div>
                </div>

                <div class="bg-white p-5 rounded-xl border-l-4 border-amber-500 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xs font-bold text-amber-600 uppercase tracking-widest">Auditoria de Vieses e Omiss√µes</h2>
                        <span class="text-[10px] bg-amber-50 text-amber-600 px-2 py-1 rounded font-mono">An√°lise Cr√≠tica (ACD)</span>
                    </div>
                    <p class="text-[11px] text-slate-500 mb-3 border-b border-slate-100 pb-2">A An√°lise Cr√≠tica do Discurso (Norman Fairclough) investiga o enquadramento institucional, identificando pontos de tens√£o (vi√©s de confirma√ß√£o e omiss√µes estrat√©gicas) em rela√ß√£o aos contrapontos.</p>
                    
                    <ul id="lista-alertas" class="space-y-4 text-sm text-slate-700 mt-2"></ul>
                </div>
				<div class="bg-white p-5 rounded-xl border-l-4 border-indigo-600 shadow-sm mt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-xs font-bold text-indigo-600 uppercase tracking-widest">Proje√ß√£o Estrat√©gica de Cen√°rios</h2>
                        <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-mono">Teoria dos Jogos</span>
                    </div>
                    <p class="text-[11px] text-slate-500 mb-4 border-b border-slate-100 pb-3">C√°lculo preditivo do comportamento organizacional p√≥s-decis√£o (Equil√≠brio de Nash), baseado no choque de interesses extra√≠do dos documentos.</p>
                    
                    <div id="matriz-plays-container" class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                        </div>
                    
                    <div class="mt-4 flex items-center justify-between">
                        <div class="text-[11px] text-slate-500">Para detalhamento gr√°fico e simula√ß√£o avan√ßada:</div>
                        <button onclick="switchTab('exportar')" class="text-xs text-indigo-600 font-bold hover:underline">Ver Exporta√ß√£o PLAYS &rarr;</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-briefing" class="tab-content">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h2 class="font-semibold text-slate-800 mb-2">Distribui√ß√£o Estrat√©gica</h2>
                <p class="text-xs text-slate-500 mb-6 border-b border-slate-100 pb-4">
                    Selecione o formato de sa√≠da. O <strong>Resumo Executivo</strong> √© otimizado para leitura r√°pida, enquanto o <strong>Dossi√™ Anal√≠tico</strong> detalha as 4 metodologias aplicadas (Toulmin, Bardin, Fairclough e Equil√≠brio de Nash).
                </p>
                
                <div class="space-y-4">
                    <button onclick="copiarZap()" class="w-full bg-[#25D366] text-white font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-[#1da851] transition text-sm flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <span class="text-lg">üí¨</span> Resumo para WhatsApp
                        </span>
                        <span class="text-[10px] uppercase opacity-80 font-normal tracking-widest">Copiar</span>
                    </button>
                    
                    <button onclick="baixarPDF()" class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-slate-900 transition text-sm flex items-center justify-between uppercase tracking-wide">
                        <span class="flex items-center gap-2">
                            <span class="text-lg">üìÑ</span> Dossi√™ Anal√≠tico (PDF)
                        </span>
                        <span class="text-[10px] opacity-80 font-normal tracking-widest">Baixar</span>
                    </button>
                </div>
            </div>
        </section>
		
        <section id="tab-exportar" class="tab-content">
            <div class="grid grid-cols-1 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-slate-800 text-sm uppercase">Exporta√ß√£o Matem√°tica (ANP)</h3>
                        <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">M√©todo de Saaty</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Gera a matriz estruturada para o <strong>Analytic Network Process</strong>. Fundamental para calcular a Raz√£o de Consist√™ncia (CR) e provar a integridade l√≥gica dos pesos decis√≥rios adotados na portaria.</p>
                    <button onclick="exportarANP()" class="bg-slate-800 text-white px-4 py-3 rounded-lg text-xs font-bold uppercase w-full tracking-widest hover:bg-slate-700">Baixar JSON (ANP-Solver)</button>
                </div>
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-slate-800 text-sm uppercase">Mapeamento Sist√™mico (CATWOE)</h3>
                        <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">Sistemas Checkland</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Exporta a taxonomia da decis√£o para o <strong>Peixe-Voador</strong>, organizando o problema sob a √≥tica dos Atores, Transforma√ß√£o, Vis√£o de Mundo e Restri√ß√µes Ambientais.</p>
                    <button onclick="exportarPeixe()" class="bg-slate-600 text-white px-4 py-3 rounded-lg text-xs font-bold uppercase w-full tracking-widest hover:bg-slate-500">Baixar JSON (Peixe-Voador)</button>
                </div>
				<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-slate-800 text-sm uppercase">Proje√ß√£o de Cen√°rios (PLAYS)</h3>
                        <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">Teoria dos Jogos</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Exporta o choque de interesses detectado nos documentos para simular as rea√ß√µes (Equil√≠brio de Nash) na ferramenta <strong>PLAYS</strong>.</p>
                    <button onclick="exportarPLAYS()" class="bg-indigo-600 text-white px-4 py-3 rounded-lg text-xs font-bold uppercase w-full tracking-widest hover:bg-indigo-500">Baixar JSON (PLAYS)</button>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around items-center h-16 px-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
        <button onclick="switchTab('analisar')" class="nav-btn active flex flex-col items-center p-2 text-slate-400 w-1/4" data-target="tab-analisar">
            <span class="text-xl mb-1">‚öôÔ∏è</span>
            <span class="text-[10px] font-bold uppercase">Auditar</span>
        </button>
        <button onclick="switchTab('relatorio')" class="nav-btn flex flex-col items-center p-2 text-slate-400 w-1/4" data-target="tab-relatorio">
            <span class="text-xl mb-1">üìä</span>
            <span class="text-[10px] font-bold uppercase">Resultados</span>
        </button>
        <button onclick="switchTab('briefing')" class="nav-btn flex flex-col items-center p-2 text-slate-400 w-1/4" data-target="tab-briefing">
            <span class="text-xl mb-1">üìë</span>
            <span class="text-[10px] font-bold uppercase">Parecer</span>
        </button>
        <button onclick="switchTab('exportar')" class="nav-btn flex flex-col items-center p-2 text-slate-400 w-1/4" data-target="tab-exportar">
            <span class="text-xl mb-1">üì§</span>
            <span class="text-[10px] font-bold uppercase">Exportar</span>
        </button>
    </nav>

    <style>
        .nav-btn.active { color: #0f172a; } 
        .nav-btn.active span:first-child { transform: scale(1.1); transition: 0.2s; }
    </style>

    <script>
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelector(`[data-target="tab-${tabId}"]`).classList.add('active');
            window.scrollTo(0, 0);
        }

        // --- Vari√°veis de Estado Global ---
        let dossieDocumentos = []; // Array que guardar√° os arquivos e classifica√ß√µes
        let dadosAuditoria = { alternativas: [], criteriosDirex: [], alertas: [], rawTextDirex: "", rawTextCritica: "" };

        // =====================================================================
        // GERENCIADOR DE DOCUMENTOS (Nova L√≥gica de M√∫ltiplos Arquivos)
        // =====================================================================
        function adicionarDocumento() {
            const inputClassificacao = document.getElementById('doc-classificacao');
            const inputArquivo = document.getElementById('doc-arquivo');
            const file = inputArquivo.files[0];

            if (!file) {
                alert("Por favor, selecione um arquivo PDF ou TXT.");
                return;
            }

            // Pega o texto da op√ß√£o selecionada (ex: "Voto de Diretoria")
            const nomeClassificacao = inputClassificacao.options[inputClassificacao.selectedIndex].text;
            const tipo = inputClassificacao.value; // ex: "oficial_voto"

            dossieDocumentos.push({
                id: Date.now(),
                file: file,
                tipo: tipo,
                nomeAmigavel: nomeClassificacao,
                nomeArquivo: file.name
            });

            inputArquivo.value = ""; // Limpa o input
            atualizarListaDocumentos();
        }

        function removerDocumento(id) {
            dossieDocumentos = dossieDocumentos.filter(doc => doc.id !== id);
            atualizarListaDocumentos();
        }

        function atualizarListaDocumentos() {
            const ul = document.getElementById('lista-documentos');
            ul.innerHTML = dossieDocumentos.map(doc => `
                <li class="flex justify-between items-center bg-white border border-slate-200 p-2 rounded-md shadow-sm">
                    <div class="flex flex-col overflow-hidden">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">${doc.nomeAmigavel}</span>
                        <span class="text-xs text-slate-700 truncate">${doc.nomeArquivo}</span>
                    </div>
                    <button onclick="removerDocumento(${doc.id})" class="text-red-500 hover:bg-red-50 p-1 rounded">
                        üóëÔ∏è
                    </button>
                </li>
            `).join('');
        }

        // =====================================================================
        // FUN√á√ÉO PRINCIPAL DE PROCESSAMENTO (Substitui a anterior)
        // =====================================================================
        async function processarDossie() {
            const btn = document.getElementById('btn-processar');
            const loader = document.getElementById('loading-indicator');
            
            // Valida√ß√£o de Governan√ßa: Exige pelo menos um documento oficial
            const temOficial = dossieDocumentos.some(doc => doc.tipo.startsWith('oficial_'));
            if (!temOficial) {
                alert("Para fins de auditoria, adicione pelo menos um Documento Oficial (Voto, Memorando ou Of√≠cio).");
                return;
            }

            btn.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                let textoOficialAcumulado = "";
                let textoCriticaAcumulado = "";

                // L√™ todos os arquivos carregados na mem√≥ria de forma ass√≠ncrona
                for (const doc of dossieDocumentos) {
                    // ATEN√á√ÉO: Mant√©m a sua fun√ß√£o lerArquivoTextoOPDF com a Blob URL intacta!
                    const textoExtraido = await lerArquivoTextoOPDF({ files: [doc.file] }); 
                    
                    // Agrupa os textos conforme a taxonomia
                    if (doc.tipo.startsWith('oficial_')) {
                        textoOficialAcumulado += textoExtraido + " \n\n ";
                    } else if (doc.tipo.startsWith('critica_')) {
                        textoCriticaAcumulado += textoExtraido + " \n\n ";
                    }
                }
                
                dadosAuditoria.rawTextDirex = textoOficialAcumulado;
                dadosAuditoria.rawTextCritica = textoCriticaAcumulado;
                
                // === APLICA√á√ÉO DOS MOTORES ANAL√çTICOS (Sem alterar os motores originais) ===
                dadosAuditoria.alternativas = extratorToulmin(textoOficialAcumulado);
                dadosAuditoria.criteriosDirex = extratorBardin(textoOficialAcumulado);
                dadosAuditoria.alertas = extratorFairclough(textoOficialAcumulado, textoCriticaAcumulado);

               setTimeout(() => {
                    renderizarRelatorio();
                    renderizarProjecaoPlays(); 
                    btn.classList.remove('hidden');
                    loader.classList.add('hidden');
                    switchTab('relatorio');
                }, 1200);

            } catch (error) {
                alert("Falha t√©cnica na extra√ß√£o. Verifique os arquivos.");
                console.error(error);
                btn.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        async function lerArquivoTextoOPDF(fileInput) {
            const file = fileInput.files[0];
            if (!file) return "";
            
            if (file.type === "application/pdf") {
                // Truque arquitetural: Cria uma URL virtual local (Blob URL).
                // Mant√©m o Zero-Trust (nada vai para a internet) e evita o erro RangeError (-1),
                // pois permite que o pdf.js use seu leitor nativo otimizado.
                const fileUrl = URL.createObjectURL(file);
                
                try {
                    const pdf = await pdfjsLib.getDocument(fileUrl).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(" ") + " ";
                    }
                    
                    // Limpa a URL virtual da mem√≥ria do celular para n√£o causar vazamento de RAM
                    URL.revokeObjectURL(fileUrl); 
                    return fullText;
                    
                } catch (pdfError) {
                    URL.revokeObjectURL(fileUrl); // Limpa a mem√≥ria mesmo em caso de erro
                    console.error("Erro interno no motor PDF:", pdfError);
                    alert("Aviso: Este PDF possui uma trava militar ou corrup√ß√£o de cabe√ßalho. Para audit√°-lo, salve-o como .txt (Bloco de Notas) e carregue novamente.");
                    throw pdfError;
                }
            } else {
                return await file.text(); // L√™ arquivos de texto simples normalmente
            }
        }

        // =====================================================================
        // MOTOR 1: TOULMIN (Extra√ß√£o Estrutural e L√≥gica)
        // =====================================================================
        function extratorToulmin(textoBase) {
            let alternativasEncontradas = [];
            
            // Procura verbos de imposi√ß√£o seguidos dos seus objetos (A Alega√ß√£o)
            const regexAcao = /(?:aprov[ou|ar|a]+|decidi[u|r]|extin[√ß√£o|guiu|gir]|institu[iu|ir]|retorno\s+a[o]?)\s+([^,\.]+)/gi;
            let match;
            
            while ((match = regexAcao.exec(textoBase)) !== null) {
                // Filtra capturas muito curtas para evitar lixo sint√°tico
                if(match[1].length > 8 && match[1].length < 80) {
                    // Capitaliza a primeira letra para ficar elegante no relat√≥rio
                    let textoLimpo = match[1].trim();
                    textoLimpo = textoLimpo.charAt(0).toUpperCase() + textoLimpo.slice(1);
                    alternativasEncontradas.push(textoLimpo);
                }
            }
            
            // Remove duplicatas
            let unicas = [...new Set(alternativasEncontradas)];
            return unicas.length > 0 ? unicas : ["A√ß√£o diretiva impl√≠cita (Verifique o par√°grafo principal do documento)"];
        }

        // =====================================================================
        // MOTOR 2: BARDIN (An√°lise de Conte√∫do, Frequ√™ncia e Peso)
        // =====================================================================
        function extratorBardin(textoBase) {
            const textoLower = textoBase.toLowerCase();
            
            // Dicion√°rio Anal√≠tico da Gest√£o P√∫blica
            const taxonomia = {
                "Cultura Organizacional e Sinergia": ["cultura", "integra√ß√£o", "pertencimento", "alinhamento", "colabora√ß√£o", "clima", "presencial", "sinergia"],
                "Seguran√ßa Jur√≠dica e Conformidade": ["passivo", "jur√≠dic", "controle", "jornada", "legisla√ß√£o", "seguran√ßa", "ponto", "roleta", "lei"],
                "Desempenho Institucional": ["desempenho", "produtividade", "efici√™ncia", "resultados", "entregas", "metas"],
                "Sustentabilidade Financeira (OPEX)": ["financeiro", "custo", "despesa", "or√ßamento", "economia", "gasto", "financeira"]
            };

            let criteriosExtraidos = [];

            for (let [categoria, radicais] of Object.entries(taxonomia)) {
                let frequencia = 0;
                
                // Conta quantas vezes os radicais aparecem no texto
                radicais.forEach(radical => {
                    // Regex para pegar a palavra baseada no radical
                    let regex = new RegExp(radical + "\\w*", "g");
                    let ocorrencias = textoLower.match(regex);
                    if (ocorrencias) frequencia += ocorrencias.length;
                });

                if (frequencia > 0) {
                    let pesoQualitativo = frequencia >= 4 ? "Alta densidade/Prioridade M√°xima" : "Relev√¢ncia Secund√°ria";
                    criteriosExtraidos.push({
                        nome: categoria, 
                        frequencia: frequencia,
                        analise: `[Bardin] Ocorr√™ncia de ${frequencia} termos relacionados. ${pesoQualitativo} no constructo do discurso oficial.`
                    });
                }
            }
            
            // Ordena do crit√©rio mais citado para o menos citado
            return criteriosExtraidos.sort((a, b) => b.frequencia - a.frequencia);
        }

        // =====================================================================
        // MOTOR 3: FAIRCLOUGH (An√°lise Cr√≠tica e Detec√ß√£o de Omiss√µes)
        // =====================================================================
        function extratorFairclough(textoDir, textoCrit) {
            let alertas = [];
            let dirLower = textoDir.toLowerCase();
            
            if (textoCrit && textoCrit.trim().length > 10) {
                let critLower = textoCrit.toLowerCase();
                
                // Regra de Omiss√£o T√°tica (Framing Bias)
                if ((critLower.includes("financeir") || critLower.includes("despesa") || critLower.includes("custo")) && 
                    !(dirLower.includes("financeir") || dirLower.includes("custo"))) {
                    alertas.push("<strong>Vi√©s de Enquadramento (Framing Bias):</strong> O documento opositor ancora argumentos na 'Sustentabilidade Financeira'. A aus√™ncia deste l√©xico no documento oficial configura uma omiss√£o t√°tica. Em auditorias, a exclus√£o de impacto or√ßament√°rio caracteriza fragilidade processual.");
                }
                
                // Regra de Disputa de Signos
                if ((critLower.includes("produtiv") || critLower.includes("efici√™nci")) && 
                    (dirLower.includes("produtiv") || dirLower.includes("efici√™nci"))) {
                    alertas.push("<strong>Ruptura de Signos (Disputa Sem√¢ntica):</strong> Constata-se diverg√™ncia diametral na apropria√ß√£o do termo 'Efici√™ncia'. A gest√£o atrela o conceito √† presencialidade; a oposi√ß√£o, a entregas remotas. Requer blindagem via dados quantitativos.");
                }
            } else {
                alertas.push("<strong>Alerta de Isola√ß√£o (Groupthink):</strong> O documento foi analisado sem contraponto externo. Recomenda-se submeter manifesta√ß√µes do p√∫blico-alvo para mapeamento preventivo de conflitos laborais.");
            }

            // Regra de Justificativa Subjetiva vs Objetiva
            if (dirLower.includes("cultura") && dirLower.includes("pertencimento") && !dirLower.match(/\d+(%| reais| milh√µes| horas)/)) {
                 alertas.push("<strong>Risco de Fundamenta√ß√£o Intang√≠vel:</strong> O discurso oficial foca em vari√°veis comportamentais ('cultura', 'integra√ß√£o') sem apresentar m√©tricas exatas associadas. Necess√°ria valida√ß√£o matricial (Raz√£o de Consist√™ncia) para provar objetividade.");
            }

            return alertas;
        }

        // =====================================================================
        // FUN√á√ÉO PRINCIPAL DE PROCESSAMENTO (Substitua a sua antiga por esta)
        // =====================================================================
        async function processarArquivos() {
            const btn = document.getElementById('btn-processar');
            const loader = document.getElementById('loading-indicator');
            const fileDecisao = document.getElementById('file-decisao');
            
            if (!fileDecisao.files.length) {
                alert("Para fins de auditoria, o carregamento do documento oficial √© obrigat√≥rio.");
                return;
            }

            btn.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                // Extrai os textos puros dos arquivos
                const textoDirex = await lerArquivoTextoOPDF(document.getElementById('file-decisao'));
                const textoCritica = await lerArquivoTextoOPDF(document.getElementById('file-critica'));
                
                dadosAuditoria.rawTextDirex = textoDirex;
                dadosAuditoria.rawTextCritica = textoCritica;
                
                // === APLICA√á√ÉO DOS MOTORES ANAL√çTICOS ===
                dadosAuditoria.alternativas = extratorToulmin(textoDirex);
                dadosAuditoria.criteriosDirex = extratorBardin(textoDirex);
                dadosAuditoria.alertas = extratorFairclough(textoDirex, textoCritica);

                // Delay estrat√©gico para percep√ß√£o de processamento complexo
                setTimeout(() => {
                    renderizarRelatorio();
                    btn.classList.remove('hidden');
                    loader.classList.add('hidden');
                    switchTab('relatorio');
                }, 1200);

            } catch (error) {
                alert("Falha t√©cnica no processamento do documento. Verifique se o PDF √© um texto leg√≠vel (n√£o imagem).");
                console.error(error);
                btn.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function renderizarRelatorio() {
            document.getElementById('resultado-vazio').classList.add('hidden');
            document.getElementById('resultado-preenchido').classList.remove('hidden');

            document.getElementById('lista-alternativas').innerHTML = dadosAuditoria.alternativas.map(a => `<li><span class="font-medium text-slate-800">${a}</span></li>`).join('');

            document.getElementById('tags-criterios').innerHTML = dadosAuditoria.criteriosDirex.map(c => 
                `<div class="bg-slate-50 border border-slate-200 p-2 rounded"><div class="font-bold text-slate-800 text-sm">${c.nome}</div><div class="text-[11px] text-slate-500 mt-1">${c.analise}</div></div>`
            ).join('');

            document.getElementById('lista-alertas').innerHTML = dadosAuditoria.alertas.map(a => `<li class="relative pl-5 before:content-[''] before:absolute before:left-0 before:top-2 before:w-2 before:h-2 before:bg-amber-500 before:rounded-full">${a}</li>`).join('');
        }

        // =====================================================================
        // MOTORES DE DISTRIBUI√á√ÉO (WhatsApp e Dossi√™ PDF)
        // =====================================================================

        function copiarZap() {
            if(!dadosAuditoria.alternativas.length) return alert("Execute a auditoria primeiro.");
            
            const temConflito = dadosAuditoria.alertas.some(a => a.includes("Disputa") || a.includes("Vi√©s"));
            const nash = temConflito ? "DD (Conflito/Travamento - Risco de Queda de Produtividade)" : "DC (Conformidade Passiva)";
            
            // Formata√ß√£o nativa do WhatsApp usando * para negrito
            let zap = `*RELAT√ìRIO EXECUTIVO - GENTE FORENSE* ‚öñÔ∏è\n\n`;
            zap += `*Decis√£o:* ${dadosAuditoria.alternativas[0]}\n`;
            zap += `*Fator Cr√≠tico (Bardin):* ${dadosAuditoria.criteriosDirex[0]?.nome || "N/A"}\n\n`;
            
            if(temConflito) {
                zap += `üö® *Alerta de Governan√ßa (Fairclough):* Foi detectada diverg√™ncia estrutural entre a narrativa oficial e o contraponto (vi√©s de omiss√£o ou disputa de conceitos).\n\n`;
            }
            
            zap += `üìä *Proje√ß√£o Estrat√©gica (Nash):* A imposi√ß√£o atual projeta um cen√°rio *${nash}*. Recomenda-se alinhar t√°ticas de mitiga√ß√£o para atingir o quadrante de ganha-ganha (CC).\n\n`;
            zap += `_Gerado por ecossistema GENTE_`;

            navigator.clipboard.writeText(zap).then(() => {
                alert("Resumo executivo copiado! Pronto para colar no WhatsApp.");
            });
        }

        function baixarPDF() {
            if(!dadosAuditoria.alternativas.length) return alert("Execute a auditoria primeiro.");
            
            // Inicializa o jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let y = 20; // Posi√ß√£o vertical inicial
            const margin = 15;
            const maxWidth = 180; // Largura m√°xima antes da quebra de linha
            const pageHeight = 280; // Altura segura antes de criar nova p√°gina

            // Fun√ß√£o auxiliadora para desenhar texto, gerenciar quebras de p√°gina e estilos
            function addText(text, fontSize = 10, fontStyle = "normal", color = [0,0,0], indent = 0) {
                doc.setFontSize(fontSize);
                doc.setFont("helvetica", fontStyle);
                doc.setTextColor(color[0], color[1], color[2]);
                const lines = doc.splitTextToSize(text, maxWidth - indent);
                
                // Verifica se precisa de nova p√°gina
                if (y + (lines.length * (fontSize * 0.4)) > pageHeight) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(lines, margin + indent, y);
                y += (lines.length * (fontSize * 0.4)) + 4; // Avan√ßa o cursor Y
            }

            // ================= CABE√áALHO DO DOCUMENTO =================
            addText("DOSSI√ä DE AUDITORIA E RASTREABILIDADE DECIS√ìRIA", 15, "bold", [15, 23, 42]);
            y += 1;
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, y, 210 - margin, y); // Linha separadora
            y += 6;

            addText("ESCOPO E METODOLOGIA CIENT√çFICA", 11, "bold", [37, 99, 235]);
            addText("Este documento t√©cnico apresenta a desconstru√ß√£o estrutural e a avalia√ß√£o de conformidade do acervo documental submetido. O objetivo √© fornecer √† Alta Gest√£o uma auditoria narrativa e proje√ß√£o de riscos institucionais, processada integralmente via algoritmos heur√≠sticos fundamentados em quatro frameworks consagrados de an√°lise de sistemas sociais, lingu√≠stica e pesquisa operacional.", 10, "normal", [60, 60, 60]);
            y += 4;

            // ================= 1. TOULMIN =================
            addText("1. ESTRUTURA L√ìGICA (M√©todo de Stephen Toulmin)", 11, "bold", [37, 99, 235]);
            addText("Metodologia: O framework de argumenta√ß√£o de Toulmin desmembra a ret√≥rica para isolar a 'Alega√ß√£o Central' (a a√ß√£o diretiva imposta) de seus 'Apoios' legais. Identifica o n√∫cleo impositivo da decis√£o.", 9, "italic", [120, 120, 120]);
            addText("Ato Diretivo (Alega√ß√£o) Identificado:", 10, "bold", [0,0,0], 0);
            dadosAuditoria.alternativas.forEach(alt => {
                addText("‚Ä¢ " + alt, 10, "normal", [0,0,0], 5);
            });
            y += 4;

            // ================= 2. BARDIN =================
            addText("2. PESOS AXIOL√ìGICOS (An√°lise de Conte√∫do - Laurence Bardin)", 11, "bold", [37, 99, 235]);
            addText("Metodologia: O m√©todo qualitativo de Bardin infere as prioridades e o modelo mental do tomador de decis√£o atrav√©s do mapeamento de coocorr√™ncia e densidade (frequ√™ncia) de clusters sem√¢nticos. √â utilizado para fundamentar matematicamente a pondera√ß√£o de crit√©rios.", 9, "italic", [120, 120, 120]);
            dadosAuditoria.criteriosDirex.forEach(c => {
                addText(c.nome.toUpperCase(), 10, "bold", [50,50,50], 0);
                addText(c.analise, 10, "normal", [0,0,0], 5);
                y += 2;
            });
            y += 2;

            // ================= 3. FAIRCLOUGH =================
            addText("3. RISCOS DE GOVERNAN√áA (An√°lise Cr√≠tica do Discurso - N. Fairclough)", 11, "bold", [37, 99, 235]);
            addText("Metodologia: A ACD examina as rela√ß√µes de poder e a pr√°tica institucional por tr√°s do texto. O algoritmo cruza o documento prim√°rio com os manifestos adjacentes para detectar vieses de enquadramento (Framing Bias), omiss√µes estrat√©gicas e disputas de significados que exp√µem a decis√£o a fragilidades em auditorias externas.", 9, "italic", [120, 120, 120]);
            
            if(dadosAuditoria.alertas.length > 0) {
                dadosAuditoria.alertas.forEach(a => {
                    // Limpa as tags HTML (<strong>) geradas para a tela
                    let textoLimpo = a.replace(/<\/?strong>/g, "");
                    addText("‚Ä¢ " + textoLimpo, 10, "normal", [0,0,0], 5);
                    y += 2;
                });
            } else {
                addText("Nenhum desvio cr√≠tico ou assimetria de governan√ßa detectado no escopo documental.", 10, "normal", [0,0,0], 5);
            }
            y += 4;

            // ================= 4. NASH =================
            addText("4. PROJE√á√ÉO ESTRAT√âGICA (Teoria dos Jogos / Equil√≠brio de Nash)", 11, "bold", [37, 99, 235]);
            addText("Metodologia: Modelagem prospectiva de cen√°rios baseada na matriz de ganhos (*payoffs*). Avalia os incentivos √† retalia√ß√£o, in√©rcia ou coopera√ß√£o entre os atores sist√™micos (Decisor vs. Impactados).", 9, "italic", [120, 120, 120]);
            
            const temConflito = dadosAuditoria.alertas.some(a => a.includes("Disputa") || a.includes("Vi√©s"));
            const nash = temConflito ? "DD (Lose-Lose / Travamento e Retalia√ß√£o)" : "DC (Conformidade / Imposi√ß√£o e Submiss√£o)";
            
            addText("Estado Atual Projetado: " + nash, 10, "bold", [temConflito ? 200 : 0, temConflito ? 50 : 0, temConflito ? 50 : 0]);
            
            let nashText = temConflito 
                ? "S√≠ntese: Constatou-se uma assimetria extrema de interesses. A imposi√ß√£o r√≠gida (Estrat√©gia D) frente √† forte resist√™ncia mapeada trava o sistema no quadrante DD. O resultado projetado no m√©dio prazo inclui judicializa√ß√£o, perda de conhecimento t√°cito, evas√£o de talentos e queda oculta de produtividade (Quiet Quitting). Para assegurar a governan√ßa, a Diretoria deve adotar manobras t√°ticas de mitiga√ß√£o operacional para deslocar o equil√≠brio para a Coopera√ß√£o M√∫tua (CC)."
                : "S√≠ntese: O ambiente projeta absor√ß√£o da regra com conformidade passiva (DC). A gest√£o deve monitorar indicadores secund√°rios de moral e reten√ß√£o de talentos no pr√≥ximo semestre.";
            
            addText(nashText, 10, "normal", [0,0,0], 0);
            y += 15;

            // ================= RODAP√â / ASSINATURA =================
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, y, 210 - margin, y);
            y += 5;
            
            // Pega a data atual
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            addText(`Documento gerado localmente pelo Motor GENTE Forense em ${dataAtual}.`, 8, "italic", [150, 150, 150]);
            addText("Processamento Client-Side (Zero-Trust). Nenhum dado foi transmitido a servidores externos.", 8, "italic", [150, 150, 150]);

            // Baixa o arquivo
            doc.save("Dossie_Tecnico_Forense_Analise_Profunda.pdf");
        }
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportarANP() {
            if(!dadosAuditoria.alternativas.length) return alert("Execute a an√°lise t√©cnica primeiro.");
            const anpData = {
                metadata: { judgeRole: "Assessoria T√©cnica Especializada", context: "Modelagem Forense da Decis√£o", frameworkUsed: "Toulmin + Bardin" },
                dynamicClusters: {
                    ObjetivoPrincipal: "Auditoria Cient√≠fica do Regime de Trabalho",
                    "Criterios de Decisao": { elements: dadosAuditoria.criteriosDirex.map(c => c.nome) },
                    "Alternativas para alcane do Objetivo": { elements: dadosAuditoria.alternativas }
                }
            };
            downloadJSON(anpData, 'Auditoria_Estrutura_ANP.json');
        }

        function exportarPeixe() {
             if(!dadosAuditoria.alternativas.length) return alert("Execute a an√°lise t√©cnica primeiro.");
             const peixeData = {
                effect: "Restabelecimento da Coes√£o Institucional e Seguran√ßa de Conformidade",
                sector: "generic",
                causes: {
                    transformation: dadosAuditoria.alternativas.map(a => ({text: "*" + a})),
                    worldview: dadosAuditoria.criteriosDirex.map(c => ({text: c.nome + " como vetor inegoci√°vel da institui√ß√£o."}))
                }
            };
            downloadJSON(peixeData, 'Auditoria_Mapeamento_CATWOE.json');
        }

        
		function exportarPLAYS() {
            if(!dadosAuditoria.alternativas.length) return alert("Execute a an√°lise t√©cnica primeiro.");
            
            // Verifica se houve contraponto (Manifesto vs Decis√£o)
            const temConflito = dadosAuditoria.alertas.some(a => a.includes("Disputa") || a.includes("Vi√©s"));
            
            const playsData = {
              "projectMeta": {
                "title": "Proje√ß√£o Forense: " + dadosAuditoria.alternativas[0],
                "context": "An√°lise de impactos e rea√ß√µes p√≥s-decis√£o institucional.",
                "objective": "Mapear o Equil√≠brio de Nash do conflito documental."
              },
              "nodes": [
                {
                  "id": "decisao_oficial",
                  "label": "A Decis√£o:\n" + dadosAuditoria.alternativas[0],
                  "group": "project",
                  "title": "Ato imposto pelo documento oficial"
                },
                {
                  "id": "jogador_A",
                  "label": "Gest√£o (DIREX)\n(Autor do Voto)",
                  "group": "actor",
                  "interest": 8, // Interesse alto extra√≠do pelo peso de Bardin
                  "title": "Objetivo: " + (dadosAuditoria.criteriosDirex[0]?.nome || "Conformidade")
                },
                {
                  "id": "jogador_B",
                  "label": "Corpo Funcional\n(Autores do Manifesto)",
                  "group": "actor",
                  "interest": temConflito ? -7 : 2, // Se houver contraponto, o interesse √© negativo (rejei√ß√£o)
                  "title": "Objetivo: Manuten√ß√£o de benef√≠cios / Flexibilidade"
                },
                {
                  "id": "estrat_DD",
                  "label": "Cen√°rio DD:\nImposi√ß√£o x Resist√™ncia",
                  "group": "strategy",
                  "color": "#ef4444",
                  "title": "Queda de moral, judicializa√ß√£o e perda de produtividade oculta."
                },
                {
                  "id": "estrat_CC",
                  "label": "Cen√°rio CC:\nAlinhamento T√°tico",
                  "group": "strategy",
                  "color": "#10b981",
                  "title": "Gest√£o mant√©m regra, mas oferece contrapartida operacional."
                }
              ],
              "edges": [
                { "from": "jogador_A", "to": "decisao_oficial", "label": "Imp√µe", "arrows": "to" },
                { "from": "jogador_B", "to": "decisao_oficial", "label": "Sofre Impacto", "arrows": "to" },
                { "from": "estrat_DD", "to": "jogador_B", "label": "Risco Iminente", "arrows": "to", "dashes": true, "color": { "color": "#ef4444" } },
                { "from": "estrat_CC", "to": "jogador_B", "label": "Rota de Mitiga√ß√£o", "arrows": "to", "width": 2, "color": { "color": "#10b981" } }
              ],
              "gameMatrix": {
                "currentState": temConflito ? "DD" : "DC",
                "targetState": "CC",
                "payoffs": {
                  "CC": { "A": 6, "B": 5, "description": "Conformidade com manuten√ß√£o de engajamento." },
                  "CD": { "A": -2, "B": 6, "description": "Recuo institucional enfraquece a governan√ßa." },
                  "DC": { "A": 7, "B": -4, "description": "Conformidade for√ßada; risco de Turnover." },
                  "DD": { "A": -3, "B": -3, "description": "Conflito aberto, desgaste institucional." }
                }
              }
            };
            
            downloadJSON(playsData, 'Auditoria_Projecao_PLAYS.json');
        }
		// =====================================================================
        // MOTOR DE PROJE√á√ÉO (Teoria dos Jogos / PLAYS Embutido)
        // =====================================================================
        function renderizarProjecaoPlays() {
            const container = document.getElementById('matriz-plays-container');
            
            // Verifica se h√° conflito (manifesto/oposi√ß√£o)
            const temConflito = dadosAuditoria.alertas.some(a => a.includes("Disputa") || a.includes("Vi√©s"));
            
            // Defini√ß√£o dos Atores
            const decisor = "A: Gest√£o";
            const impactado = "B: Equipes";
            
            // Estado de Nash (Se h√° conflito, tende a DD. Se n√£o, tende a DC)
            const nashState = temConflito ? "DD (Conflito/Travamento)" : "DC (Conformidade Passiva)";
            const bgColorNash = temConflito ? "bg-red-100 border-red-300" : "bg-blue-100 border-blue-300";
            const txtColorNash = temConflito ? "text-red-700" : "text-blue-700";

            // Desenha a Matriz 2x2 Simplificada
            container.innerHTML = `
                <div class="mb-3">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Equil√≠brio de Nash Projetado:</span>
                    <div class="mt-1 font-bold text-sm ${txtColorNash} ${bgColorNash} border px-3 py-2 rounded">
                        ${nashState}
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1 text-center text-[10px]">
                    <div></div>
                    <div class="font-bold text-slate-600 bg-slate-200 py-1 rounded rounded-b-none">${impactado}<br>Aceita/Coopera</div>
                    <div class="font-bold text-slate-600 bg-slate-200 py-1 rounded rounded-b-none">${impactado}<br>Resiste/Rejeita</div>
                    
                    <div class="font-bold text-slate-600 bg-slate-200 py-2 flex items-center justify-center rounded rounded-r-none">${decisor}<br>Alinha/Mitiga</div>
                    <div class="border border-slate-300 bg-white p-2 flex flex-col justify-center">
                        <span class="font-bold text-emerald-600 text-xs">CC (Ganha-Ganha)</span>
                        <span class="text-[9px] text-slate-500 mt-1">Produtividade e Controle</span>
                    </div>
                    <div class="border border-slate-300 bg-white p-2 flex flex-col justify-center opacity-60">
                        <span class="font-bold text-slate-700 text-xs">CD</span>
                        <span class="text-[9px] text-slate-500 mt-1">Perda de Autoridade</span>
                    </div>
                    
                    <div class="font-bold text-slate-600 bg-slate-200 py-2 flex items-center justify-center rounded rounded-r-none">${decisor}<br>Imp√µe Rigor</div>
                    <div class="border border-slate-300 bg-white p-2 flex flex-col justify-center ${!temConflito ? 'ring-2 ring-blue-400 bg-blue-50' : 'opacity-60'}">
                        <span class="font-bold text-slate-700 text-xs">DC</span>
                        <span class="text-[9px] text-slate-500 mt-1">Risco de Turnover</span>
                    </div>
                    <div class="border border-slate-300 bg-white p-2 flex flex-col justify-center ${temConflito ? 'ring-2 ring-red-400 bg-red-50' : 'opacity-60'}">
                        <span class="font-bold ${temConflito ? 'text-red-600' : 'text-slate-700'} text-xs">DD (Lose-Lose)</span>
                        <span class="text-[9px] text-slate-500 mt-1">Desgaste e Queda Oculta</span>
                    </div>
                </div>
                
                <p class="text-[10px] text-slate-500 mt-3 italic text-center">
                    ${temConflito 
                        ? "Aviso: A imposi√ß√£o r√≠gida frente a forte oposi√ß√£o documental trava a matriz no quadrante DD. Recomenda-se estrat√©gia de mitiga√ß√£o (CC)."
                        : "Cen√°rio de conformidade com submiss√£o (DC). Monitorar indicadores de reten√ß√£o de talentos no m√©dio prazo."}
                </p>
            `;
        }
    </script>
</body>

</html>
