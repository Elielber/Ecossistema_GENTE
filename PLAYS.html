<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAYS 1.1 - Project Strategy Framework</title>
    
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAKTElEQVR4AaRWe1RVVRr/7XvPvXB5e2FgSApQM03kUVikjko+0ijHVzST1ahj48qSVi2MkMml+VqNVo6ZM7Za04T8YcxShOQhaCSIMogoCsaVy/Pyft8398I9Z759SCaXZq3VPnvvc/b+Xr/9fd/e+yjwK4okSVye/QoV4Ap+kXxmcaZX3tm8RwsLc6OLiwujS0rOPVZaWrqc2hPFxcWxhYWF0bm5udH5+fmReXl5Pr9IKTH9LIDKykrVmTN5K3xGfJLUTFXMFKqrgHBVkoQrEqQsSRLLFQrFZUEQrqpUwlVBpaxgTNpKIFZwWbJx36q4HzUrK8uvu7szWSmosgSFsEclqAPVKjcolUowxlBYWoWisqsQJRGCIMDNzR1EdxME9V9VaiGrvb09uaCgYMb9bPwkgPwz+Vu9vb0/cXPT7FUJaqhUqjE9POLUTp+vwLHsYmTkfIdjOedQdLGK6AyMerVazYFAo9HsdXNzO5ib/81Wmr5nvSeA3PzcVLVKnUYrXTdumFT39ffjUnk5vjh+GqeKyiHS3MioC0UXqlFd1wR9gx71DQ1gjMMAyDj31iI3tSbtm2+yU++F4C4A+Wdyt5JgiqAUfCm2YPQYTUacyDqBK1VVeDAkBH0mO+zDDqJIsk6JXkqmRMjEiejs6kJ6RgYGBweJziARUVCpfN01mhQCcZcn7gCQfzZ/llKpWqFUCL4gpXwhw45hfHUsg4YMT8fHk5EQKJUCXKQYTAJjBJGB6OAux+y4OCSueQFnCosw7HDIAAkF3FTuvp6e3qtycnLixibH+nEAlZVHVRajZZE4Ks5WMAVGncMYsdnR3deHxYsWYc2qVRRXlSz11ivLMTU8BBq1Ozw0bpg2KQTJr60iFBIobOR6NV58MRHpGcdgJz1O5whGRRdsNlvc0NBQ/NGjR8cUkbZxAIbOwARvL6+9Gg8NrAM9uLhvN84mv4UJghLTp0/ji4XN7kBHTz/ST53FivhYbH8zEWmbE7F4dhR2HspAc2c3zFYbqQUdMAzPrXweaf/ejz3HP8Wluitw9/SANsB/r5+/X4LMRJ0MIDs721tySZEuF7kUDLqvM2Ht6gTtL1wiIKb2NgyaLMj5thy7/vE1vi2vwYF/ZSP1k3SkfZyOQxm5+L6hA9s+SsfxvBIYzVYKiYTPsr8iHYDFZkXp9f9C39YIHg4iPpGZmelL9gko9S6XPVStEt7x8vSkEVVGjWLME4h8B0tPD/StnTh5rhxDZhtlPx1BFP9FT0Xj6bgoygeRdIoA5cP5yzXIzC+B2WKjOb4g3oA+4wD07c3w8fEFbdMUURTDQEX2gNFoF+y2YRkRNyq6RBko94CkZAiOisGDwb/BupULsW7VQqxeEoe1zy1AmFaN8AA11j6/gOaeovd8vLw8XuaVaBExU2aQHpHMAA9ogzAzfJrsAbvVpjCZTIwTZACBgYHw8fPjY7lNXpaAmM1vInrzZkT/+S9g9AT5+2LZ3MexlNry+DgsmzcLtbU1qL5aDQ+XBc/zud/FyvSl9PaheC+JnYcNz/4BGxP+iBfmP4fw4Idk/Vr/AEykLcsHMgA68dQad3c+BtlC15UKNOTmUDuNpqICcvEIbhdJlOhTQn5eHpxOp5z1oWFhKCu7AMYY0cYqYwzHCk/gTOV5FFQU42RpnpwH3MMeGg0EJoTRt0JByaCmrbGUjnOSpAQ8eQKt352DpdUAs6EVg/X1uPzxAaIBjJ6SkvP49PCniIqOwubXX0fSW0mYMnkSQkPDUEogwAsDDmd/iaZuA9r7uuTW1t+FAesQmIJRWADzsPkjOhM8ZQ+I4iiJja1MHHVCGqW4EYWRIvCUo33cQjvh74cPQav1R/I7yXQgTYSSpJSSi7MgfFIYfLx9cOjwZ2hobMTwiJNSSCTIEiQmyW9umVZNUhLovFGbzWamSExMdGq1AQX8AIFskaxSlcjVDIyYGShj8RAdwVve2IKICEosAmUZ6sGFnMPIPpoMi6mHzgmGqMhIJL35BqZMmkxjbnRMnpSQBPWkn3Gd/K1Ufku7YYTWCfSbzU6TxUIcP1QJxMYIsAQFZwagEATQJORC9KqzX8HS1wrR5UTF6X9iqKdJJvGOr5I32TXyBHW0rRljYAoFrDYb1BrNQVq8XQZQX1uLNoOBuAAFXaWMGwNZIaGwhYsRPOtJCotr3P7Yh0QcnIfBbhlE4/VSMMbAZC3AYw/PxLyZT8H1w5YmVbInJVFEB4VTV1NDwoAMwNfX1+Xp5WHnskExj8OLtoj7AxPxyOpETHvxJYQvWQZyByePNRKVxrKWxhLcvXwR+uhsYpEIFOQSHz0HK+Ysxe/nPIO5kbMQ7B9I58B08CIolbh9zcsAHA5Hy5DJdKCzowN+lM0RL72CyFfX4yYdzaAVkHUud0ebMXsVYp/ZiNilGxEV/xL8H5h8Bx0/+EIaciJImIDE+csxOTgUXd3dGB527PPw8JBjJgNISkoyOW3WKpdrVBbzC5sELSWSXq+XtxZjDD8utRdP4WZ5NuqvFKK+qgDf07j05Mdoqin7PxtlPk9ene4WIqdHIDQwBOQ4OOh6t1iMFZs2bTJyZhkA//Dw8M5tbm7a1k7x4duGr/r1TZtQfeMGVGoVASMQVOsqTqO5tgSmvnaYBlph7u2gN333tmCwt5EMWEkdg0S76Isvv8T6P62Dt48PzQHNTU2orand5u3tlytPUDcOgBCN+Pj4FXl6epWBMoYWQJeGGzauX08Hz2coryiH1dwP81AXJJeLREUwUQFJQeuiypfXoatEx61KipoLxzP/g1fXvgx3dzUggsgi/LQT+qZOnWrgtkiBXMcB8NGWLVsqdXpddl9vn1EkEFyMfs/wwuo14P+DzbUV6G6sAeSQkCiTCAS5hfNKGC8lpaV4ZsliuNPPCuhWEuFCd0+38WZN7d82bNiQMc5IH6SF+h/Vre9s3a9vaPiwt7eXQBB0omm1WiQsexYBv30QQeEz8NuwmZR0U2hbEUTmgueEYJqfSfOR8PANQPyCBXRiasE3ikTL58Zv3br1YWpq6n5Sd0e9CwCnpqSk7NM36vfYrJb0lpaWsQUTISgsArOWvkZtI2IWvoLwyPkIn7EAEXNWI3bZa9Q2IuihCOKkSh5pbGzAwMDA5Yb6hj3vp72/j2bvqvcEwLlSU1L3V1RUvl1Xd3NbPV1ITc1NYPRwGm/uHn6YOXc1IuauQUDII4AcBgk8Ok10F+hu6VBbW7utrl7/dlpa2l0r5zp4+0kAnLhz586B0NDwAwaDYWVHZ8cH129ct1+6dBEDg/1QCoxYuEEGfsMN0m942cUyVFdXi4Z2w77WlpaVpodNB7a9+24ZMf5kvS8ALsUzdseOHaccdsdHA/0DT3Z1GmKsDltMa0vzhro63Qd1ups7TEbjPPo3iGkztMX09PQ8plKqPty9e/epzzd9PsJ13K/9LIDbwuQN0/bt228cPHjk2trEtdd0Ov2x9vb2PW1tHfsSEhIu0MVy7ciRI9d27dpV/d577xlvy/3c+38AAAD//4N36u8AAAAGSURBVAMAYZqBAgnqDggAAAAASUVORK5CYII=">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ================================================================== */
        /* =================== DESIGN SYSTEM PLAYS  ====================== */
        /* ================================================================== */
        
        :root {
            /* Cores Institucionais */
            --sidebar-bg: #1A233A;
            --sidebar-text: #A0AEC0;
            --sidebar-hover: #2D3748;
            --sidebar-active: #2D3748;
            --accent-color: #4FD1C5; /* Teal */
            --primary-blue: #005a9c;
            
            /* Canvas & Fundo */
            --bg-color: #f4f7f9;
            --dot-color: #e2e8f0;
            --card-bg: #ffffff;
            
            /* Post-its */
            --note-yellow: #fff7d1;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color);
            color: #333; 
            height: 100vh;
            overflow: hidden; /* App feel */
        }

        /* LAYOUT GERAL (Sidebar + Main) */
        .app-wrapper {
            display: grid;
            grid-template-columns: 260px 1fr;
            height: 100vh;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            border-right: 1px solid #111;
            z-index: 100;
        }
        
        .brand-area {
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid #2D3748;
        }
        .brand-area h1 {
            color: white;
            font-size: 1.5rem;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .brand-area p { font-size: 0.75rem; font-style: italic; }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
            flex-grow: 1;
        }
        
        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            border-left: 4px solid transparent;
        }
        
        .nav-item:hover { background-color: var(--sidebar-hover); color: white; }
        .nav-item.active {
            background-color: var(--sidebar-active);
            color: white;
            border-left-color: var(--accent-color);
        }
        .nav-item i { margin-right: 12px; width: 20px; text-align: center; }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #2D3748;
        }

        .global-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            background-color: var(--bg-color);
            /* Dot Grid Background */
            background-image: radial-gradient(var(--dot-color) 2px, transparent 2px);
            background-size: 24px 24px;
            overflow-y: auto;
            position: relative;
            padding: 0;
        }

        /* Header da P√°gina (Breadcrumbs) */
        .view-header {
            padding: 20px 40px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .view-title h2 { font-size: 1.5rem; color: #1a202c; }
        .view-title span { color: #718096; font-size: 0.9rem; }

        /* Container de cada View (Fase) */
        .view-section {
            display: none; /* Escondido por padr√£o */
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease-in-out;
        }
        .view-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ESTILOS ESPEC√çFICOS DO CANVAS (FASE 1) --- */
        /* Mantendo o Grid Original Rigoroso, mas estilizando as c√©lulas como cards */
        
        .custom-canvas-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, minmax(140px, auto)) auto; /* Altura m√≠nima maior */
            gap: 20px; /* Mais respiro entre as "ilhas" */
            padding-bottom: 60px;
        }

        .canvas-section {
            background-color: #ffffff; /* Fundo branco (Ilha) */
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e2e8f0; /* Borda sutil */
            box-shadow: var(--shadow-sm); /* Sombra suave */
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* Headers coloridos para dar contexto visual */
        .canvas-section h5 {
            text-align: center;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 10px;
            border-bottom: 2px solid transparent;
            margin-bottom: 10px;
            color: #4A5568;
            font-weight: 700;
        }

        .canvas-section:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .canvas-section.drag-over { background-color: #f0fff4; border-color: #48bb78; border-style: dashed; }

        /* Aplica√ß√£o das Cores de Fundo Originais de forma mais sutil (Borda superior) */
        .grid-justificativa, .grid-objsmart, .grid-beneficios { border-top: 4px solid #4FD1C5; } /* Ciano */
        .grid-produto, .grid-requisitos { border-top: 4px solid #4299E1; } /* Azul */
        .grid-stakeholders, .grid-equipe { border-top: 4px solid #ED64A6; } /* Rosa */
        .grid-premissas, .grid-entregas, .grid-restricoes { border-top: 4px solid #ECC94B; } /* Amarelo */
        .grid-riscos, .grid-tempo, .grid-custo { border-top: 4px solid #F56565; } /* Vermelho */
        .grid-rascunho { border-top: 4px solid #CBD5E0; }

        /* Posicionamento do Grid (ID√äNTICO AO ORIGINAL) */
        .grid-justificativa { grid-column: 1; grid-row: 1; }
        .grid-objsmart { grid-column:  1; grid-row: 2; }
        .grid-beneficios { grid-column: 1; grid-row: 3 / 5; }
        .grid-produto { grid-column: 2; grid-row: 1; }
        .grid-requisitos { grid-column: 2; grid-row: 2 / 5; }
        .grid-stakeholders { grid-column: 3; grid-row: 1; }
        .grid-equipe { grid-column: 3; grid-row: 2 / 4; }
        .grid-premissas { grid-column: 4; grid-row: 1; }
        .grid-entregas { grid-column: 4; grid-row: 2 / 4; }
        .grid-restricoes { grid-column: 3 / 5; grid-row: 4; }
        .grid-riscos { grid-column: 5; grid-row: 1; }
        .grid-tempo { grid-column: 5; grid-row: 2 / 4; }
        .grid-custo { grid-column: 5; grid-row: 4; }
        .grid-rascunho { grid-column: 1 / 4; grid-row: 5; background: #f7fafc; border: 2px dashed #cbd5e0;}
        .grid-ferramentas { 
            grid-column: 4 / 6; grid-row: 5; 
            background: transparent; border: none; box-shadow: none;
            display: flex; justify-content: flex-end; align-items: center;
        }

        /* --- POST-ITS (Estilo Visual) --- */
        .post-it { 
            position: relative; 
            background-color: var(--note-yellow); 
            padding: 12px; 
            border-radius: 2px; /* Cantos quase retos de papel */
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); 
            margin-bottom: 10px; 
            cursor: grab; 
            font-size: 0.9rem; 
            line-height: 1.4;
            color: #2D3748;
            font-family: 'Kalam', cursive, sans-serif; /* Fonte manuscrita opcional, ou fallback */
            transition: transform 0.2s, box-shadow 0.2s;
            transform: rotate(-1deg); /* Rota√ß√£o natural */
        }
        .post-it:nth-child(even) { transform: rotate(1deg); }
        .post-it:hover { transform: scale(1.05) rotate(0deg); z-index: 10; box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        .post-it.selected { outline: 2px solid #3182ce; }
        .post-it-text { outline: none; min-height: 20px; }
        .delete-post-it-btn { position: absolute; top: -5px; right: -5px; background: #e53e3e; color: white; border-radius: 50%; width: 20px; height: 20px; border: none; cursor: pointer; display: none; align-items:center; justify-content:center; font-size: 12px;}
        .post-it:hover .delete-post-it-btn { display: flex; }

        /* --- ELEMENTOS DE UI GERAIS (Bot√µes e Inputs) --- */
        .tool-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }
        .tool-card h5 { font-size: 1.1rem; color: #2D3748; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        input[type="text"], select, textarea {
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(79, 209, 197, 0.2); }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .btn-primary:hover { background-color: #00447a; transform: translateY(-1px); }
        
        .btn-secondary { background-color: #718096; color: white; }
        .btn-secondary:hover { background-color: #4A5568; }
        
        .btn-accent { background-color: var(--accent-color); color: #1A202C; }
        .btn-success { background-color: #48BB78; color: white; }
        .btn-danger { background-color: #F56565; color: white; }

        /* Sidebar Buttons */
        .sidebar-btn {
            width: 100%;
            background: #2D3748;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.85rem;
            text-align: left;
            display: flex; align-items: center; gap: 8px;
        }
        .sidebar-btn:hover { background: #4A5568; }

        /* Color Palette */
        #color-palette { display: flex; gap: 8px; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s;}
        .color-swatch:hover { transform: scale(1.2); }

        /* --- FASE 3 (SIMULA√á√ÉO) - LAYOUT DASHBOARD --- */
        .simulation-dashboard {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
            height: 600px; /* Altura fixa para o dashboard */
        }
        .network-panel { background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 15px; display: flex; flex-direction: column;}
        .nash-panel { background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 15px; overflow-y: auto;}

        /* --- SUBSTITUA O CSS DO #network-graph POR ESTE --- */

#network-graph { 
    width: 100%; 
    height: 500px; /* Altura fixa obrigat√≥ria para evitar loop do Canvas */
    border: 1px solid #e2e8f0; /* Borda para visualizar a √°rea */
    background: #f7fafc;
}

.network-panel { 
    background: white; 
    border-radius: 8px; 
    border: 1px solid #e2e8f0; 
    padding: 15px; 
    display: flex; 
    flex-direction: column;
    overflow: hidden; /* Garante que nada vaze do container */
}
        
        /* Sliders */
        .slider-group { margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; font-size: 0.85rem;}
        .scenario-card { background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #edf2f7; }
        .scenario-title { font-weight: bold; font-size: 0.8rem; color: #4A5568; margin-bottom: 5px; }

        /* Matriz de Nash */
        .payoff-matrix { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 5px; margin-top: 15px; font-size: 0.8rem; }
        .matrix-cell { border: 1px solid #cbd5e0; padding: 10px; text-align: center; background: white; position: relative; border-radius: 4px;}
        .nash-equilibrium { background-color: #C6F6D5 !important; border-color: #48BB78; box-shadow: 0 0 5px #48BB78; }
        .nash-badge { position: absolute; top: -8px; right: -8px; background: #48BB78; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.6rem; font-weight: bold; }

        /* --- FASE 5 (IMPLEMENTA√á√ÉO) --- */
        .implementation-board { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; min-height: 500px; }
        .round-column { flex: 1; min-width: 280px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .round-header { padding: 15px; background: #e2e8f0; border-radius: 8px 8px 0 0; font-weight: bold; color: #4A5568; text-align: center; border-bottom: 1px solid #cbd5e0; }
        .round-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        
        .action-card { background: white; padding: 15px; border-radius: 6px; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; border-left-width: 4px; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; color: white; margin-bottom: 5px; }
        .status-success { background: #48BB78; }
        .status-fail { background: #F56565; }
        .status-pending { background: #A0AEC0; }

        /* ================================================================== */
        /* =================== ESTILOS DE IMPRESS√ÉO (OFICIAL) =============== */
        /* ================================================================== */
        @media print { /* 1. Esconde a Interface do Usu√°rio */ body > * { display: none !important; }
            
         /* 2. Mostra APENAS o Relat√≥rio */
         #printable-report { display: block !important; position: absolute;  left: 0;  top: 0;  width: 100%; }

        /* 3. Configura√ß√µes de P√°gina (A4) */
         @page {size: A4;margin: 2.5cm; /* Margem generosa para encaderna√ß√£o/furos */@bottom-right { content: "P√°gina " counter(page); font-size: 9pt;color: #555; } }

        /* 4. Tipografia de Documento Oficial */
         body {font-family: 'Times New Roman', Times, serif; /* Serifa passa mais credibilidade */font-size: 12pt;line-height: 1.5;color: #000;background: #fff;}

         /* 5. Estiliza√ß√£o dos Elementos do Relat√≥rio */
        .report-cover {height: 90vh; /* Ocupa a primeira p√°gina inteira */display: flex;flex-direction: column;justify-content: center;align-items: center;text-align: center;page-break-after: always;}
        .report-header { border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
        .report-section { margin-bottom: 30px; page-break-inside: avoid; } /* Evita quebrar tabelas no meio */
        .report-title { font-size: 24pt; font-weight: bold; margin-bottom: 10px; }
        .report-subtitle { font-size: 14pt; font-style: italic; margin-bottom: 40px; }
            
         h1 { font-size: 18pt; border-bottom: 1px solid #ccc; margin-top: 20px; color: #003366 !important; }
         h2 { font-size: 14pt; margin-top: 15px; color: #333 !important; }
            
         /* Caixas de Destaque (Diagn√≥stico/Estrat√©gia) */
         .box-diagnosis { border: 1px solid #ccc; background-color: #f9f9f9 !important; padding: 10px; margin: 10px 0; font-size: 11pt; -webkit-print-color-adjust: exact; }
         .box-strategy { border: 1px solid #000; background-color: #f0f0f0 !important; padding: 15px; margin: 10px 0; font-weight: 500; -webkit-print-color-adjust: exact; }
            
          /* Tabela Simples para Dados */
         .doc-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
         .doc-table th, .doc-table td { border: 1px solid #000; padding: 8px; text-align: left; }
         .doc-table th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
         
		 .competency-highlight {background-color: #d4edda;color: #155724;border-bottom: 2px solid #28a745; /* Linha verde forte embaixo */font-weight: bold;padding: 0 2px;border-radius: 3px;cursor: help;}
		 

        /* --- OUTROS (Upload, Listas) --- */
        .file-uploader { border: 2px dashed #cbd5e0; padding: 30px; text-align: center; border-radius: 8px; transition: all 0.2s; background: #fcfcfc;}
        .file-uploader:hover { border-color: var(--accent-color); background: #f0fff4; }
        .file-label { background: var(--primary-blue); color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; display: inline-block; margin-bottom: 10px; font-weight: 600;}
        .uploaded-files-list { margin-top: 15px; }
        .file-list-item { background: white; border: 1px solid #e2e8f0; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }

        /* Charts */
        .chart-container { width: 100%; min-height: 200px; margin-top: 20px; }

    </style>
</head>
<body>

    <div class="app-wrapper">
        
        <aside class="sidebar">
            <div class="brand-area">
                <h1>PLAYS 1.1</h1>
                <p>Strategic Project Framework</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item active" onclick="switchView('phase1')">
                    <i class="fas fa-palette"></i> Fase 1: Canvas
                </li>
                <li class="nav-item" onclick="switchView('phase2')">
                    <i class="fas fa-search-location"></i> Fase 2: Mapeamento
                </li>
                <li class="nav-item" onclick="switchView('phase3')">
                    <i class="fas fa-balance-scale"></i> Fase 3: Simula√ß√£o
                </li>
                <li class="nav-item" onclick="switchView('phase4')">
                    <i class="fas fa-chess"></i> Fase 4: Estrat√©gia
                </li>
                <li class="nav-item" onclick="switchView('phase5')">
                    <i class="fas fa-rocket"></i> Fase 5: Rounds
                </li>
				<li class="nav-item" onclick="switchView('phase6')">
                 <i class="fas fa-chart-line"></i> Fase 6: Auditoria
                </li>
            </ul>

            <div class="sidebar-footer">
                <div class="global-actions">
                    <button id="save-btn" class="sidebar-btn"><i class="fas fa-save"></i> Salvar Projeto</button>
                    <button id="load-btn" class="sidebar-btn"><i class="fas fa-folder-open"></i> Carregar JSON</button>
                    <input type="file" id="load-json-input" accept=".json" hidden>
                    <button id="export-report-btn" class="sidebar-btn" style="background:#6B46C1"><i class="fas fa-file-pdf"></i> Gerar Relat√≥rio</button>
                </div>
            </div>
        </aside>

        <main class="main-content">

            <div id="view-phase1" class="view-section active">
                <div class="view-header">
                    <div class="view-title">
                        <span>Fase 1</span>
                        <h2>Project Model Canvas</h2>
                    </div>
                    <div>
                         <input type="text" id="project-name-input" placeholder="Nome do Projeto..." style="width: 250px;">
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <div class="tool-card">
                         <div style="display:flex; gap: 15px; margin-bottom: 10px;">
                            <div style="flex:1">
                                <label style="font-size: 0.8rem; font-weight:bold;">Tipo de Projeto:</label>
                                <select id="dna-type" onchange="checkProjectCoherence()" style="width:100%">
                                    <option value="">-- Selecione --</option>
                                    <option value="inovacao">Inova√ß√£o / P&D</option>
                                    <option value="engenharia">Engenharia / Cascata</option>
                                    <option value="evento">Evento / Data Fixa</option>
                                </select>
                            </div>
                            <div style="flex:1">
                                <label style="font-size: 0.8rem; font-weight:bold;">Restri√ß√£o Principal:</label>
                                <select id="dna-constraint" onchange="checkProjectCoherence()" style="width:100%">
                                    <option value="">-- Selecione --</option>
                                    <option value="escopo">Escopo</option>
                                    <option value="prazo">Prazo</option>
                                    <option value="custo">Custo</option>
                                </select>
                            </div>
                         </div>
                         <div id="coherence-feedback" style="display:none; padding:10px; border-radius:4px; font-size:0.85rem; margin-top:5px;"></div>
                         
                         <div style="margin-top:10px;">
                            <label style="font-size:0.8rem; font-weight:bold;">Tags T√©cnicas (Detectadas):</label>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="project-tech-tags" style="flex-grow:1;" placeholder="Ex: Python, Engenharia Civil...">
                                <button id="auto-tag-btn" class="control-btn btn-secondary" style="font-size:0.8rem;">‚ö° Extrair</button>
                            </div>
                         </div>
                    </div>

                    <div class="custom-canvas-container">
                        <div id="justificativa" class="canvas-section grid-justificativa" data-payoff-type="Status"><h5>Justificativa</h5></div>
                        <div id="objsmart" class="canvas-section grid-objsmart" data-payoff-type="Status"><h5>OBJ smart</h5></div>
                        <div id="beneficios" class="canvas-section grid-beneficios" data-payoff-type="Status"><h5>Beneficios</h5></div>
                        <div id="produto" class="canvas-section grid-produto" data-payoff-type="Autonomia"><h5>Produto</h5></div>
                        <div id="requisitos_clientes" class="canvas-section grid-requisitos" data-payoff-type="Autonomia"><h5>Requisitos</h5></div>
                        <div id="restricoes" class="canvas-section grid-restricoes" data-payoff-type="Autonomia"><h5>Restri√ß√µes</h5></div>
                        <div id="stakeholders" class="canvas-section grid-stakeholders" data-payoff-type="Poder"><h5>Stakeholders</h5></div>
                        <div id="entregas" class="canvas-section grid-entregas" data-payoff-type="Poder"><h5>Entregas</h5></div>
                        <div id="premissas" class="canvas-section grid-premissas" data-payoff-type="Seguran√ßa"><h5>Premissas</h5></div>
                        <div id="riscos" class="canvas-section grid-riscos" data-payoff-type="Seguran√ßa"><h5>Riscos</h5></div>
                        <div id="tempo" class="canvas-section grid-tempo" data-payoff-type="Seguran√ßa"><h5>Linha do Tempo</h5></div>
                        <div id="equipe" class="canvas-section grid-equipe" data-payoff-type="Recursos"><h5>Equipe</h5></div>
                        <div id="custo" class="canvas-section grid-custo" data-payoff-type="Recursos"><h5>Custo</h5></div>
                        <div id="rascunho" class="canvas-section grid-rascunho" data-payoff-type="Geral"><h5>Rascunho</h5></div>
                        
                        <div id="ferramentas" class="canvas-section grid-ferramentas" id="canvas-tools">
                            <div class="floating-toolbar" style="background: white; padding: 10px 20px; border-radius: 50px; box-shadow: var(--shadow-md); display: flex; gap: 10px; align-items: center;">
                                <span style="font-size:0.8rem; color:#888; margin-right:5px;">Post-it:</span>
                                <div id="color-palette">
                                    <div class="color-swatch" style="background-color: #fff7d1;" data-color="#fff7d1"></div>
                                    <div class="color-swatch" style="background-color: #d4edda;" data-color="#d4edda"></div>
                                    <div class="color-swatch" style="background-color: #cce5ff;" data-color="#cce5ff"></div>
                                    <div class="color-swatch" style="background-color: #f8d7da;" data-color="#f8d7da"></div>
                                </div>
                                <span style="font-size:0.7rem; color:#aaa; margin-left:10px;">Duplo clique para criar</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-phase2" class="view-section">
                <div class="view-header">
                    <div class="view-title">
                        <span>Fase 2</span>
                        <h2>An√°lise e Mapeamento</h2>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top:30px;">
                    <div>
                        <div class="tool-card">
                            <h5>1. Cadastro de Jogadores</h5>
                            <div class="player-input-form" style="display:flex; flex-direction:column; gap:10px;">
                                <input type="text" id="player-name" placeholder="Nome">
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="player-title" placeholder="Cargo">
                                    <input type="text" id="player-company" placeholder="Empresa">
                                </div>
                                <input type="text" id="player-level" placeholder="N√≠vel (ex: 1.0)">
                                <button id="add-player-btn" class="control-btn btn-primary">Adicionar Jogador</button>
                            </div>
                            <ul id="player-list" style="margin-top:15px; list-style:none; padding:0;"></ul>
                            <div style="margin-top:10px;">
                                <button id="generate-map-btn" class="control-btn btn-secondary">Atualizar Organograma</button>
                            </div>
                            <div id="chart-container" class="chart-container"></div>
                        </div>

                        <div class="tool-card">
                            <h5>2. Mapeamento de Influ√™ncia</h5>
                             <div id="interference-form" style="display:flex; flex-direction:column; gap:10px;">
                                <select id="influencer-select"></select>
                                <select id="influenced-select"></select>
                                <select id="dimension-select">
                                    <option value="Pol√≠tico">Pol√≠tico</option>
                                    <option value="T√©cnico">T√©cnico</option>
                                    <option value="Pessoal">Pessoal</option>
                                </select>
                                <input type="range" id="strength-input" min="1" max="5" value="3">
                                <span id="strength-value">For√ßa: 3</span>
                                <button id="add-connection-btn" class="control-btn btn-primary">Adicionar Conex√£o</button>
                            </div>
                            <ul id="connection-list" style="margin-top:10px;"></ul>
                            <button id="generate-influence-map-btn" class="control-btn btn-secondary" style="margin-top:10px;">Gerar Sankey</button>
                            <div id="influenceChartContainer" class="chart-container"></div>
                        </div>
                    </div>

                    <div>
                        <div class="tool-card">
                            <h5>3. An√°lise Documental (IA Simb√≥lica)</h5>
                            <div class="file-uploader">
                                <label for="doc-uploader" class="file-label"><i class="fas fa-upload"></i> Escolher PDF</label>
                                <input type="file" id="doc-uploader" accept=".pdf" hidden>
                                <div id="file-name" style="margin-top:10px; color:#718096; font-size:0.9rem;">Nenhum arquivo</div>
                            </div>
                            <div id="uploaded-files-list" class="uploaded-files-list" style="display:none;"></div>
                            
                            <div id="payoff-notes" style="border:1px solid #eee; height: 150px; overflow-y:auto; padding:10px; margin-top:15px; font-size:0.85rem;" contenteditable="true"></div>
                            <div id="payoff-tags" style="display:none;"></div> <div style="margin-top:15px; display:flex; gap:10px;">
                                <button id="re-highlight-btn" class="control-btn btn-secondary">Refazer Destaques</button>
                                <button id="analyze-payoffs-btn" class="control-btn btn-secondary">Analisar Payoffs</button>
                            </div>
                            
                            <div id="payoff-chart-container" class="chart-container"></div>
                        </div>

                        <div class="tool-card">
                            <div style="display:flex; justify-content:space-between;">
                                <h5>4. Compet√™ncias (Tri√¢ngulo PMI)</h5>
                                <button id="calc-competencies-btn" class="control-btn btn-accent" style="font-size:0.8rem;">Recalcular</button>
                            </div>
                            <div id="competency-chart-container" class="chart-container"></div>
                        </div>
                        
                         <div class="tool-card">
                            <h5>5. Reputa√ß√£o (Tit-for-Tat)</h5>
                            <div id="reputation-chart-container" class="chart-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-phase3" class="view-section">
                <div class="view-header">
                    <div class="view-title">
                        <span>Fase 3</span>
                        <h2>Diagn√≥stico e Teoria dos Jogos</h2>
                    </div>
                </div>

                <div style="margin-top:30px;">
                    <div class="tool-card" style="padding: 15px;">
                        <label style="font-weight:bold;">Objeto de Disputa (Do Canvas):</label>
                        <select id="game-context-select" style="width:100%; padding:10px; margin-top:5px; background:#f0f9ff; border-color:#bee3f8;">
                            <option>Carregue o projeto primeiro...</option>
                        </select>
                    </div>

                    <div class="simulation-dashboard">
                        <div class="network-panel" id="network-container-wrapper">
                            <h6 style="text-align:center; color:#718096; margin-bottom:10px;">RADAR DE PODER & INTERESSE</h6>
                            <div id="network-graph"></div>
                            <p style="text-align:center; font-size:0.8rem; color:#718096; margin-top:10px;">Selecione 2 n√≥s para simular o conflito</p>
                        </div>

                        <div class="nash-panel" id="nash-calculator-section" style="opacity:0.6; pointer-events:none;">
                            <h6 style="text-align:center; margin-bottom:15px; color:#2D3748;">SIMULADOR DE EQUIL√çBRIO</h6>
                            <div style="background: #fff5f5; padding: 15px; border-radius: 6px; border: 1px solid #fc8181; margin-bottom: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <label style="font-weight:bold; color:#c53030; font-size:0.9rem;">
            <i class="fas fa-temperature-high"></i> N√≠vel de Politiza√ß√£o do Ambiente
        </label>
        <span id="politicization-val" style="font-weight:bold; color:#c53030;">80%</span>
    </div>
    <input type="range" id="politicization-level" min="0" max="100" value="80" style="width:100%; accent-color: #f56565;">
    <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#718096; margin-top:5px;">
        <span>Colaborativo (Startups/Agile)</span>
        <span>Hostil (Governo/Fus√µes)</span>
    </div>
</div>
<button id="calculate-nash-btn" class="control-btn btn-primary" style="width:100%; justify-content:center;">Simular</button>
                            
                            <div id="matrix-container"></div>
                            <div id="nash-explanation" style="font-size:0.8rem; background:#ebf8ff; padding:10px; margin-top:10px; border-radius:4px; display:none;"></div>
                            
                            <button id="save-to-strategy-btn" class="control-btn btn-success" style="width:100%; margin-top:15px; justify-content:center;">Salvar para Estrat√©gia</button>
                            <details style="margin-bottom:15px; font-size:0.8rem;">
                                <summary>Sele√ß√£o Manual</summary>
                                <select id="player-a-select" style="width:100%; margin-bottom:5px;"></select>
                                <select id="player-b-select" style="width:100%;"></select>
                            </details>

                            <div class="scenario-card">
                                <div class="scenario-title">1. Coopera√ß√£o M√∫tua (CC)</div>
                                <div class="slider-group"><span>A:</span> <input type="range" id="p1-cc" min="-5" max="5"><span id="val-p1-cc">0</span></div>
                                <div class="slider-group"><span>B:</span> <input type="range" id="p2-cc" min="-5" max="5"><span id="val-p2-cc">0</span></div>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-title">2. A Coopera, B Trai (CD)</div>
                                <div class="slider-group"><span>A:</span> <input type="range" id="p1-cd" min="-5" max="5"><span id="val-p1-cd">0</span></div>
                                <div class="slider-group"><span>B:</span> <input type="range" id="p2-cd" min="-5" max="5"><span id="val-p2-cd">0</span></div>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-title">3. A Trai, B Coopera (DC)</div>
                                <div class="slider-group"><span>A:</span> <input type="range" id="p1-dc" min="-5" max="5"><span id="val-p1-dc">0</span></div>
                                <div class="slider-group"><span>B:</span> <input type="range" id="p2-dc" min="-5" max="5"><span id="val-p2-dc">0</span></div>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-title">4. Travamento (DD)</div>
                                <div class="slider-group"><span>A:</span> <input type="range" id="p1-dd" min="-5" max="5"><span id="val-p1-dd">0</span></div>
                                <div class="slider-group"><span>B:</span> <input type="range" id="p2-dd" min="-5" max="5"><span id="val-p2-dd">0</span></div>
                            </div>

                            
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-phase4" class="view-section">
                <div class="view-header">
                    <div class="view-title">
                        <span>Fase 4</span>
                        <h2>Design de Mecanismos</h2>
                    </div>
                </div>
                
                <div style="margin-top:30px;">
                    <div id="strategy-dashboard">
                        <div id="empty-strategy-msg" style="text-align:center; padding:50px; color:#a0aec0; border: 2px dashed #e2e8f0; border-radius:8px;">
                            <h3>Nenhuma estrat√©gia salva</h3>
                            <p>Realize as simula√ß√µes na Fase 3 primeiro.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-phase5" class="view-section">
                 <div class="view-header">
                    <div class="view-title">
                        <span>Fase 5</span>
                        <h2>Implementa√ß√£o √Ågil</h2>
                    </div>
                     <button id="sync-strategies-btn" class="control-btn btn-accent">üîÑ Importar Backlog</button>
                </div>

                <div style="margin-top:30px; overflow-x:auto;">
                     <div class="implementation-board">
                        <div class="round-column" id="col-backlog">
                            <div class="round-header">Backlog</div>
                            <div class="round-content" id="list-backlog"></div>
                        </div>
                        <div class="round-column">
                            <div class="round-header" style="background:#bee3f8;">Round 1: Piloto</div>
                            <div class="round-content" id="list-round1"></div>
                        </div>
                        <div class="round-column">
                            <div class="round-header" style="background:#90cdf4;">Round 2: Expans√£o</div>
                            <div class="round-content" id="list-round2"></div>
                        </div>
                        <div class="round-column">
                            <div class="round-header" style="background:#63b3ed;">Round 3: Consolida√ß√£o</div>
                            <div class="round-content" id="list-round3"></div>
                        </div>
                     </div>
                </div>
            </div>
			<div id="view-phase6" class="view-section">
    <div class="view-header">
        <div class="view-title">
            <span>Fase 6</span>
            <h2>Auditoria de Impacto (Nash Comparativo)</h2>
        </div>
        <button onclick="renderPhase6Comparison()" class="control-btn btn-primary">üîÑ Calcular Impacto</button>
    </div>

    <div style="margin-top:30px; display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
        <div class="tool-card" style="border-top: 4px solid #F56565;">
            <h5 style="color:#F56565;">Cen√°rio Original (Fase 3)</h5>
            <div id="matrix-before" style="margin-top:15px;"></div>
            <p style="font-size:0.85rem; color:#718096; margin-top:10px; font-style:italic;">Baseado apenas em poder e interesse bruto.</p>
        </div>

        <div class="tool-card" style="border-top: 4px solid #48BB78;">
            <h5 style="color:#48BB78;">Cen√°rio P√≥s-Implementa√ß√£o</h5>
            <div id="matrix-after" style="margin-top:15px;"></div>
            <p style="font-size:0.85rem; color:#718096; margin-top:10px; font-style:italic;">Considerando reputa√ß√£o adquirida (Tit-for-Tat).</p>
        </div>
    </div>

    <div class="tool-card" style="margin-top:20px; background:#ebf8ff; border:1px solid #bee3f8;">
        <h5>üìã Diagn√≥stico Final da Mudan√ßa</h5>
        <div id="audit-diagnosis" style="font-size:1rem; color:#2c5282; padding:10px;">
            Clique em "Calcular Impacto" para ver a evolu√ß√£o.
        </div>
    </div>
</div>

        </main>
    </div>

    <div id="printable-report" style="display:none;"></div>

    <script>

     document.addEventListener('DOMContentLoaded', function () {
    
    // --- 0. CONFIGURA√á√ÉO DE BIBLIOTECAS ---
    if(typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }
    if(typeof google !== 'undefined') {
        google.charts.load('current', {packages:['orgchart', 'corechart', 'sankey', 'bar']});
    }

    // ==================================================================
    // === 1. MOTORES DE INTELIG√äNCIA (O C√âREBRO DO PLAYS 1.1) ===
    // ==================================================================

    // 1.1 Dicion√°rio de Skills (Para Leitura de Post-its e Curr√≠culos)
    const SKILL_DICTIONARY = {
        tech: ["Python", "Java", "JavaScript", "React", "Node", "AWS", "Cloud", "SQL", "DevOps", "Engenharia", "Civil", "El√©trica", "Mec√¢nica", "Obra", "BIM", "AutoCAD", "Medicina", "Enfermagem", "PMP", "Scrum", "Dados", "LGPD", "Seguran√ßa", "Arquitetura", "Estrutura"],
        biz: ["Licita√ß√£o", "Contratos", "Jur√≠dico", "Financeiro", "Or√ßamento", "Custos", "Marketing", "Vendas", "Log√≠stica", "Compras", "SAP", "KPI", "Planejamento", "Auditoria", "M&A", "Compliance", "ROI", "CAPEX", "Business Case"],
        lead: ["Lideran√ßa", "Gest√£o de Pessoas", "Negocia√ß√£o", "Influ√™ncia", "Stakeholder", "Comunica√ß√£o", "Agile Coach", "Mentoria", "Tomada de Decis√£o", "Gest√£o de Conflitos", "Empatia", "Orat√≥ria", "Facilita√ß√£o"]
    };

    // 1.2 Defini√ß√£o de Payoffs e Sin√¥nimos
    const PAYOFFS = [
        { id: 'Poder', name: 'Poder', color: '#FF6384' },
        { id: 'Status', name: 'Status', color: '#36A2EB' },
        { id: 'Seguran√ßa', name: 'Seguran√ßa', color: '#FFCE56' },
        { id: 'Recursos', name: 'Recursos', color: '#4BC0C0' },
        { id: 'Autonomia', name: 'Autonomia', color: '#9966FF' }
    ];

    const PAYOFF_THESAURUS = {
        Poder: ['influ√™ncia', 'controle', 'decis√£o', 'autoridade', 'veto', 'mandato', 'hierarquia', 'ordem', 'comando', 'governan√ßa'],
        Status: ['reconhecimento', 'visibilidade', 'promo√ß√£o', 'prest√≠gio', 'reputa√ß√£o', 'imagem', 'destaque', 'pr√™mio', 'cr√©dito', 'autoria'],
        Seguran√ßa: ['risco', 'amea√ßa', 'estabilidade', 'garantia', 'medo', 'receio', 'consequ√™ncia', 'perigo', 'seguro', 'manuten√ß√£o', 'compliance'],
        Recursos: ['or√ßamento', 'verba', 'dinheiro', 'equipe', 'pessoal', 'custo', 'financeiro', 'investimento', 'headcount', 'ferramentas'],
        Autonomia: ['independ√™ncia', 'liberdade', 'flexibilidade', 'microgerenciar', 'espa√ßo', 'interfer√™ncia', 'autoral', 'criatividade']
    };

    const CONTEXT_MAPPING = {
        'produto': 'tech', 'requisitos_clientes': 'tech', 'ferramentas': 'tech', 'entregas': 'tech', 'restricoes': 'tech',
        'custo': 'biz', 'beneficios': 'biz', 'riscos': 'biz', 'premissas': 'biz', 'tempo': 'biz',
        'stakeholders': 'lead', 'equipe': 'lead', 'justificativa': 'lead', 'objsmart': 'lead'
    };

    // 1.3 [RECUPERADO] Regras de Coer√™ncia do Projeto (DNA)
    const PROJECT_COHERENCE_RULES = {
        "inovacao": {
            "escopo": { status: "warn", msg: "‚ö†Ô∏è CUIDADO: Projetos de Inova√ß√£o pedem escopo flex√≠vel. Fixar o Escopo cedo demais pode matar a descoberta." },
            "prazo": { status: "ok", msg: "‚úÖ Time-boxing (Prazo Fixo) √© uma √≥tima restri√ß√£o para for√ßar criatividade em Inova√ß√£o." },
            "custo": { status: "ok", msg: "‚úÖ Or√ßamento fixo √© comum em P&D para limitar perdas (Stop Loss)." }
        },
        "engenharia": {
            "escopo": { status: "ok", msg: "‚úÖ Correto: Engenharia cl√°ssica exige Escopo fechado e detalhado antes da execu√ß√£o." },
            "prazo": { status: "warn", msg: "‚ö†Ô∏è RISCO: O Prazo em obras f√≠sicas depende do Escopo. Fixar Prazo arbitrariamente gera risco de seguran√ßa." },
            "custo": { status: "warn", msg: "‚ö†Ô∏è Custo em obras costuma variar com imprevistos f√≠sicos/geol√≥gicos." }
        },
        "evento": {
            "escopo": { status: "warn", msg: "‚ö†Ô∏è Em Eventos, a data √© fatal. O Escopo deve ser sacrific√°vel se algo der errado." },
            "prazo": { status: "ok", msg: "‚úÖ Perfeito: Data fatal √© a caracter√≠stica definidora de Eventos." },
            "custo": { status: "ok", msg: "‚úÖ Budget fixo √© padr√£o." }
        }
    };

    // 1.4 [RECUPERADO] Menu de T√°ticas Estrat√©gicas
    const STRATEGY_TACTICS = {
        'Poder': [
            { label: "O Direito de Veto Espec√≠fico", text: "Conceder ao stakeholder poder de veto exclusivo sobre uma etapa final (ex: Homologa√ß√£o), em troca de autonomia total durante a execu√ß√£o." },
            { label: "Cadeira no Comit√™", text: "Oferecer um assento no conselho diretor do projeto para formalizar sua influ√™ncia e co-responsabiliz√°-lo." }
        ],
        'Status': [
            { label: "O 'Sponsor' Oficial", text: "Nomear o stakeholder como 'Padrinho' da iniciativa, vinculando o sucesso do projeto √† reputa√ß√£o dele." },
            { label: "Visibilidade Exclusiva", text: "Garantir que ele fa√ßa a apresenta√ß√£o dos resultados para a diretoria (dar o palco)." }
        ],
        'Seguran√ßa': [
            { label: "Piloto Isolado (Sandbox)", text: "Propor um teste em ambiente controlado e revers√≠vel. Reduz o risco existencial." },
            { label: "Transpar√™ncia Radical", text: "Implementar um painel em tempo real acess√≠vel a ele para reduzir a ansiedade da 'caixa preta'." }
        ],
        'Recursos': [
            { label: "Fatiamento (Salami Slicing)", text: "Quebrar a aprova√ß√£o em fases menores. √â mais f√°cil aprovar 10% dez vezes do que 100% de uma vez." },
            { label: "Subs√≠dio Cruzado", text: "Utilizar recursos 'sobrando' de outro projeto de interesse dele para custear esta etapa." }
        ],
        'Autonomia': [
            { label: "Definir o 'O Qu√™', n√£o o 'Como'", text: "Acordar rigidamente os KPIs, mas dar liberdade total sobre o m√©todo." },
            { label: "Zona de Exce√ß√£o", text: "Permitir ferramentas pr√≥prias nesta √°rea, desde que a interface de entrega seja padr√£o." }
        ],
        'Geral': [
            { label: "Aumentar a Sombra do Futuro", text: "Transformar a intera√ß√£o √∫nica em recorrente para incentivar coopera√ß√£o (Tit-for-Tat)." },
            { label: "Empacotamento (Bundling)", text: "Vincular algo que ele odeia (custo) a algo que ele ama (status) num pacote √∫nico." }
        ]
    };

    // --- 2. VARI√ÅVEIS GLOBAIS DE ESTADO ---
    let influenceLinks = [];
    let canvasItems = [];
    let selectedPostItId = null;
    let globalPlayerProfiles = {}; 
    let criticalScenarios = [];
    let implementationData = [];
    let playerReputationHistory = {};
    let networkInstance = null;
	const reputationStore = {};

    // --- 3. NAVEGA√á√ÉO E UI ---
    window.switchView = function(phaseId) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navItems = document.querySelectorAll('.nav-item');
        if(phaseId === 'phase1' && navItems[0]) navItems[0].classList.add('active');
        if(phaseId === 'phase2' && navItems[1]) navItems[1].classList.add('active');
        if(phaseId === 'phase3' && navItems[2]) navItems[2].classList.add('active');
        if(phaseId === 'phase4' && navItems[3]) navItems[3].classList.add('active');
        if(phaseId === 'phase5' && navItems[4]) navItems[4].classList.add('active');
        
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById('view-' + phaseId);
        if(target) target.classList.add('active');
        setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 100);
    };

    // ==================================================================
    // === FASE 1: CANVAS, COER√äNCIA & TAGS (RECUPERADOS) ===
    // ==================================================================

    // [MOTOR] Valida√ß√£o de Coer√™ncia (DNA)
    window.checkProjectCoherence = function() {
        const type = document.getElementById('dna-type').value;
        const constraint = document.getElementById('dna-constraint').value;
        const feedbackDiv = document.getElementById('coherence-feedback');
        
        if (!type || !constraint) { feedbackDiv.style.display = 'none'; return; }
        
        const rule = PROJECT_COHERENCE_RULES[type]?.[constraint];
        if (rule) {
            feedbackDiv.innerHTML = rule.msg;
            feedbackDiv.style.display = 'block';
            feedbackDiv.style.backgroundColor = rule.status === 'warn' ? '#fff3cd' : '#d4edda';
            feedbackDiv.style.color = rule.status === 'warn' ? '#856404' : '#155724';
            feedbackDiv.style.border = rule.status === 'warn' ? '1px solid #ffeeba' : '1px solid #c3e6cb';
        } else {
            feedbackDiv.style.display = 'none';
        }
    };
    // Listeners
    const dnaType = document.getElementById('dna-type');
    const dnaConst = document.getElementById('dna-constraint');
    if(dnaType) dnaType.addEventListener('change', window.checkProjectCoherence);
    if(dnaConst) dnaConst.addEventListener('change', window.checkProjectCoherence);

    // [MOTOR] Auto-Tagging do Canvas
    window.extractCompetenciesFromCanvas = function() {
        const allText = canvasItems.map(i => i.text).join(" ").toLowerCase();
        const foundSkills = [];
        Object.entries(SKILL_DICTIONARY).forEach(([type, list]) => {
            list.forEach(skill => {
                if (allText.includes(skill.toLowerCase()) && !foundSkills.includes(skill)) {
                    foundSkills.push(skill);
                }
            });
        });
        const input = document.getElementById('project-tech-tags');
        if(input) {
            input.value = foundSkills.join(', ');
            input.style.backgroundColor = "#d4edda";
            setTimeout(() => input.style.backgroundColor = "#fff", 2000);
        }
        
        const btn = document.getElementById('auto-tag-btn');
        if(btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = foundSkills.length > 0 ? `‚úÖ ${foundSkills.length} skills!` : "‚ùå Nada encontrado";
            setTimeout(() => btn.innerHTML = originalText, 2000);
        }
    };
    const autoTagBtn = document.getElementById('auto-tag-btn');
    if(autoTagBtn) autoTagBtn.addEventListener('click', window.extractCompetenciesFromCanvas);

    // Render Canvas
    function renderAllPostIts() {
        document.querySelectorAll('.post-it').forEach(p => p.remove());
        canvasItems.forEach(item => {
            const sec = document.getElementById(item.sectionId);
            if (sec) {
                const div = document.createElement('div');
                div.className = 'post-it';
                div.id = item.id;
                div.draggable = true;
                div.style.backgroundColor = item.color || '#fff7d1';
                div.innerHTML = `<div class="post-it-text" contenteditable="true" style="outline:none; min-height:20px;">${item.text}</div><button class="delete-post-it-btn" data-id="${item.id}">√ó</button>`;
                
                const textEl = div.querySelector('.post-it-text');
                textEl.addEventListener('mousedown', (e) => { div.draggable = false; e.stopPropagation(); });
                textEl.addEventListener('mouseup', () => { div.draggable = true; });
                textEl.addEventListener('blur', (e) => {
                     const idx = canvasItems.findIndex(x => x.id === item.id);
                     if(idx > -1) canvasItems[idx].text = e.target.innerText;
                });
                div.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', item.id); div.classList.add('dragging'); });
                div.addEventListener('dragend', () => div.classList.remove('dragging'));
                div.addEventListener('click', (e) => {
                    if(e.target.classList.contains('delete-post-it-btn')) {
                        if(confirm('Deletar nota?')) { canvasItems = canvasItems.filter(x => x.id !== item.id); renderAllPostIts(); }
                        return;
                    }
                    selectedPostItId = item.id;
                    document.querySelectorAll('.post-it').forEach(p => p.classList.remove('selected'));
                    div.classList.add('selected');
                });
                sec.appendChild(div);
            }
        });
        updateGameDropdowns();
    }

    const canvasContainer = document.querySelector('.custom-canvas-container');
    if (canvasContainer) {
        canvasContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.target.closest('.canvas-section')?.classList.add('drag-over'); });
        canvasContainer.addEventListener('dragleave', (e) => { e.target.closest('.canvas-section')?.classList.remove('drag-over'); });
        canvasContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            document.querySelectorAll('.canvas-section').forEach(s => s.classList.remove('drag-over'));
            const id = e.dataTransfer.getData('text/plain');
            const sec = e.target.closest('.canvas-section');
            if (sec && sec.id !== 'ferramentas') {
                const idx = canvasItems.findIndex(i => i.id === id);
                if (idx > -1) { canvasItems[idx].sectionId = sec.id; renderAllPostIts(); }
            }
        });
        canvasContainer.addEventListener('dblclick', (e) => {
            const sec = e.target.closest('.canvas-section');
            if (sec && sec.id !== 'ferramentas') {
                canvasItems.push({ id: 'postit-' + Date.now(), text: 'Nova nota...', sectionId: sec.id, color: '#fff7d1' });
                renderAllPostIts();
            }
        });
    }
    
    document.getElementById('color-palette').addEventListener('click', (e) => {
        if(e.target.classList.contains('color-swatch') && selectedPostItId) {
            const idx = canvasItems.findIndex(i => i.id === selectedPostItId);
            if(idx > -1) { canvasItems[idx].color = e.target.dataset.color; renderAllPostIts(); }
        }
    });

    // ==================================================================
    // === FASE 2: AN√ÅLISE (PDF, GR√ÅFICOS E TEXTO) ===
    // ==================================================================

    function buildWordToPayoffMap() {
        const map = new Map();
        PAYOFFS.forEach(p => {
            const info = { name: p.id, color: p.color };
            map.set(p.id.toLowerCase(), info);
            if(PAYOFF_THESAURUS[p.id]) PAYOFF_THESAURUS[p.id].forEach(w => map.set(w.toLowerCase(), info));
        });
        return map;
    }

    function highlightAnalysisText(fullText) {
        const players = Array.from(document.querySelectorAll('#player-list li')).map(li => li.dataset.name);
        const wordToPayoffMap = buildWordToPayoffMap();
        const tagsInput = document.getElementById('project-tech-tags');
        const techTags = tagsInput ? tagsInput.value.split(',').map(s => s.trim().toLowerCase()).filter(s => s.length > 0) : [];
        const allTerms = [...new Set([...players, ...Array.from(wordToPayoffMap.keys()), ...techTags])];
        if (allTerms.length === 0) return fullText.replace(/\n/g, '<br>');

        allTerms.sort((a, b) => b.length - a.length);
        const escapeHTML = (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
        const regex = new RegExp(`\\b(${allTerms.map(t => t.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})\\b`, 'gi');

        let result = '';
        let lastIdx = 0;
        let match;
        while ((match = regex.exec(fullText)) !== null) {
            result += escapeHTML(fullText.substring(lastIdx, match.index)).replace(/\n/g, '<br>');
            const term = match[0];
            const termLower = term.toLowerCase();
            if (players.some(p => p.toLowerCase() === termLower)) {
                result += `<mark style="background:#fafa98; font-weight:bold; padding:0 2px; border-radius:3px;">${term}</mark>`;
            } else if (wordToPayoffMap.has(termLower)) {
                const info = wordToPayoffMap.get(termLower);
                result += `<mark style="background-color:${info.color}; color:white; font-weight:bold; padding:0 2px; border-radius:3px;">${term}</mark>`;
            } else if (techTags.includes(termLower)) {
                result += `<mark style="background-color:#d4edda; color:#155724; border-bottom:2px solid green;">${term}</mark>`;
            } else {
                result += term;
            }
            lastIdx = regex.lastIndex;
        }
        result += escapeHTML(fullText.substring(lastIdx)).replace(/\n/g, '<br>');
        return result;
    }

    function detectDocumentType(text) {
        const t = text.toLowerCase();
        if (t.includes('experi√™ncia') || t.includes('curriculum') || t.includes('forma√ß√£o')) return { type: 'Curr√≠culo', class: 'badge-curriculo', icon: 'üéì' };
        if (t.includes('ata') || t.includes('pauta') || t.includes('presentes:')) return { type: 'Ata', class: 'badge-ata', icon: 'üìù' };
        if (t.includes('de:') && t.includes('para:') && t.includes('assunto:')) return { type: 'E-mail', class: 'badge-email', icon: 'üìß' };
        return { type: 'Doc', class: 'badge-admin', icon: 'üìÅ' };
    }

    const docUploader = document.getElementById('doc-uploader');
    if(docUploader) {
        docUploader.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            // Feedback Visual Inicial
            const fileNameDisplay = document.getElementById('file-name');
            if(fileNameDisplay) fileNameDisplay.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Iniciando leitura de ${file.name}...`;

            const reader = new FileReader();
            reader.onload = function(e) {
                const typedarray = new Uint8Array(e.target.result);
                
                // Uso de Promise para permitir async/await dentro do fluxo do PDF.js
                pdfjsLib.getDocument(typedarray).promise.then(async (pdf) => {
                    let fullText = '';
                    const totalPages = pdf.numPages;

                    // --- IN√çCIO DA ALTERA√á√ÉO DE ROBUSTEZ (Source: 123) ---
                    // Loop p√°gina a p√°gina com pausa para n√£o travar a UI
                    for (let i = 1; i <= totalPages; i++) {
                        // Atualiza o texto da UI para mostrar progresso
                        if(fileNameDisplay) fileNameDisplay.innerText = `Lendo p√°gina ${i} de ${totalPages}...`;
                        
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                        
                        // Pausa de 10ms a cada 5 p√°ginas para liberar a Thread da UI
                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 10));
                    }
                    // --- FIM DA ALTERA√á√ÉO DE ROBUSTEZ ---
                    
                    // L√≥gica de An√°lise Original (Integrada aqui para funcionar ap√≥s o await)
                    const players = Array.from(document.querySelectorAll('#player-list li')).map(li => li.dataset.name);
                    let detectedPlayer = players.find(p => fullText.toLowerCase().includes(p.toLowerCase()));
                    const docInfo = detectDocumentType(fullText);
                    const uniqueDocId = 'doc-' + Date.now();
                    
                    // Aplica o Highlighting (Source: 48, 49)
                    const highlightedText = highlightAnalysisText(fullText);

                    // Atualiza lista visual de arquivos
                    const fileList = document.getElementById('uploaded-files-list');
                    fileList.style.display = 'block';
                    const listItem = document.createElement('div');
                    listItem.className = 'file-list-item';
                    listItem.innerHTML = `
                        <div onclick="document.getElementById('${uniqueDocId}').scrollIntoView({behavior:'smooth', block:'center'})" style="cursor:pointer; flex-grow:1;">
                            <strong>${file.name}</strong> <span class="doc-type-badge ${docInfo.class}" style="font-size:0.7em; background:#eee; padding:2px 5px; border-radius:4px;">${docInfo.type}</span>
                        </div>
                        <button onclick="this.parentElement.remove(); document.getElementById('${uniqueDocId}-wrapper').remove();" style="color:#e53e3e; border:none; background:none; font-weight:bold; cursor:pointer;">√ó</button>
                    `;
                    fileList.appendChild(listItem);

                    // Injeta o conte√∫do analisado no DOM (Source: 42)
                    const payoffNotes = document.getElementById('payoff-notes');
                    payoffNotes.innerHTML += `
                        <div id="${uniqueDocId}-wrapper" class="file-entry" style="margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding-bottom:15px;">
                            <div style="font-weight:bold; color:#2c5282; margin-bottom:5px;">
                                ${docInfo.icon} ${file.name} ${detectedPlayer ? '<span style="background:#c6f6d5; color:#22543d; font-size:0.8em; padding:2px 6px; border-radius:10px;">üë§ '+detectedPlayer+'</span>' : ''}
                            </div>
                            <div id="${uniqueDocId}" style="font-size:0.9rem; color:#4a5568; max-height:200px; overflow-y:auto; background:#fff; padding:10px; border:1px solid #edf2f7; border-radius:4px;">
                                ${highlightedText}
                            </div>
                        </div>`;
                    
                    // Finaliza e Dispara Gatilhos
                    if(fileNameDisplay) fileNameDisplay.innerText = "Arquivo carregado: " + file.name;
                    document.getElementById('calc-competencies-btn').click(); // Recalcula skills (Source: 50)
                    document.getElementById('analyze-payoffs-btn').click();   // Recalcula payoffs

                }).catch(error => { 
                    console.error(error); 
                    alert("Erro ao ler PDF: " + error.message);
                    if(fileNameDisplay) fileNameDisplay.innerText = "Erro ao processar arquivo.";
                });
            };
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Limpa o input para permitir re-upload do mesmo arquivo
        });
    }

    // [CORRE√á√ÉO] Rec√°lculo Compet√™ncias (Isolando por Arquivo)
    document.getElementById('calc-competencies-btn').onclick = () => {
        const playersList = Array.from(document.querySelectorAll('#player-list li')).map(li => li.dataset.name);
        const fileEntries = document.querySelectorAll('.file-entry'); // Captura cada arquivo individualmente
        
        // 1. Reset dos perfis
        playersList.forEach(p => { if (globalPlayerProfiles[p]) delete globalPlayerProfiles[p].mastery; });
        
        let tempScores = {};
        playersList.forEach(p => tempScores[p] = { tech: 0, biz: 0, lead: 0 });

        let hasData = false;

        // 2. L√≥gica de An√°lise (Modo Arquivo vs Modo Texto Livre)
        if (fileEntries.length > 0) {
            // MODO ARQUIVO: Analisa cada curr√≠culo separadamente
            fileEntries.forEach(entry => {
                const docText = entry.innerText;
                // Tenta achar qual jogador √© citado neste documento espec√≠fico
                const targetPlayer = playersList.find(p => docText.toLowerCase().includes(p.toLowerCase()));
                
                if (targetPlayer) {
                    // Se achou o dono do curr√≠culo, conta as skills S√ì neste texto e S√ì para ele
                    Object.entries(SKILL_DICTIONARY).forEach(([type, list]) => {
                        list.forEach(term => {
                            if (new RegExp(`\\b${term}\\b`, 'i').test(docText)) {
                                tempScores[targetPlayer][type]++;
                            }
                        });
                    });
                }
            });
        } else {
            // MODO LEGADO: Se n√£o tiver arquivos (texto colado √† m√£o), usa a l√≥gica antiga
            const rawText = document.getElementById('payoff-notes').innerText;
            playersList.forEach(player => {
                if (rawText.toLowerCase().includes(player.toLowerCase())) {
                    Object.entries(SKILL_DICTIONARY).forEach(([type, list]) => {
                        list.forEach(term => {
                            if (new RegExp(`\\b${term}\\b`, 'i').test(rawText)) tempScores[player][type]++;
                        });
                    });
                }
            });
        }

        // 3. Normaliza√ß√£o e Atualiza√ß√£o Global
        playersList.forEach(p => {
            const s = tempScores[p];
            if (s.tech > 0 || s.biz > 0 || s.lead > 0) {
                hasData = true;
                if (!globalPlayerProfiles[p]) globalPlayerProfiles[p] = {};
                globalPlayerProfiles[p].mastery = {
                    tech: Math.min(Math.ceil(s.tech * 1.5), 10),
                    biz: Math.min(Math.ceil(s.biz * 1.5), 10),
                    lead: Math.min(Math.ceil(s.lead * 1.5), 10)
                };
            }
        });

        // 4. Renderiza√ß√£o do Gr√°fico
        const container = document.getElementById('competency-chart-container');
        if(!hasData) container.innerHTML = '<p style="text-align:center; color:#a0aec0; margin-top:20px;">Sem dados de compet√™ncia. Certifique-se que o nome do jogador est√° no arquivo.</p>';
        else {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Jogador'); 
            data.addColumn('number', 'T√©cnico'); 
            data.addColumn('number', 'Neg√≥cios'); 
            data.addColumn('number', 'Lideran√ßa');
            
            Object.keys(globalPlayerProfiles).forEach(p => { 
                const m = globalPlayerProfiles[p].mastery; 
                if(m) data.addRow([p, m.tech, m.biz, m.lead]); 
            });
            
            new google.visualization.ColumnChart(container).draw(data, { 
                height: 300, 
                title: 'Tri√¢ngulo de Talentos (PMI) - Por Jogador', 
                colors: ['#4299E1', '#48BB78', '#ECC94B'] 
            });
        }
    };

    // [MODIFICA√á√ÉO] Engine de An√°lise com C√°lculo de Interesse (Frequ√™ncia)
    document.getElementById('analyze-payoffs-btn').onclick = () => {
         const players = Array.from(document.querySelectorAll('#player-list li')).map(li => li.dataset.name);
         const rawText = document.getElementById('payoff-notes').innerText;
         const container = document.getElementById('payoff-chart-container');
         const wordToPayoffMap = buildWordToPayoffMap();
         
         // Inicializa contagem
         let counts = {};
         let mentionCounts = {}; // Novo: Rastrear frequ√™ncia do nome do jogador (Interesse)
         
         players.forEach(p => { 
             counts[p] = {}; 
             mentionCounts[p] = 0;
             PAYOFFS.forEach(pay => counts[p][pay.id] = 0); 
         });

         const lines = rawText.split('\n');
         lines.forEach(line => {
             const lineLower = line.toLowerCase();
             players.forEach(p => {
                 // Contagem de men√ß√µes diretas ao jogador (Proxy para "Interesse/Envolvimento")
                 if(lineLower.includes(p.toLowerCase())) {
                     mentionCounts[p]++; 
                     
                     // Se o jogador est√° na linha, ver quais payoffs est√£o associados
                     wordToPayoffMap.forEach((info, word) => {
                         if(lineLower.includes(word)) {
                             counts[p][info.name]++;
                             if(!globalPlayerProfiles[p]) globalPlayerProfiles[p] = {};
                             globalPlayerProfiles[p][info.name] = (globalPlayerProfiles[p][info.name] || 0) + 1;
                         }
                     });
                 }
             });
         });

         // [CR√çTICO] Persistir o Score de Interesse para a Fase 3 (Simula√ß√£o)
         players.forEach(p => {
             if(!globalPlayerProfiles[p]) globalPlayerProfiles[p] = {};
             // Normaliza interesse: salva o n√∫mero absoluto de men√ß√µes
             globalPlayerProfiles[p].interestScore = mentionCounts[p];
         });

         // Renderiza√ß√£o do Gr√°fico (Mantida)
         const data = new google.visualization.DataTable();
         data.addColumn('string', 'Jogador'); 
         PAYOFFS.forEach(p => data.addColumn('number', p.name));
         
         let hasRows = false;
         Object.entries(counts).forEach(([p, vals]) => {
             const row = [p, ...PAYOFFS.map(pay => vals[pay.id])];
             if(row.slice(1).some(x => x>0)) { data.addRow(row); hasRows = true; }
         });

         if(!hasRows) container.innerHTML = '<p style="text-align:center; color:#a0aec0;">Nenhum payoff detectado nos textos.</p>';
         else new google.visualization.BarChart(container).draw(data, { isStacked: true, height: 300, colors: PAYOFFS.map(p => p.color) });
         
         alert("An√°lise conclu√≠da! N√≠veis de 'Interesse' e 'Payoffs' atualizados para a Simula√ß√£o.");
    };

    // ==================================================================
    // === FASE 3: SIMULA√á√ÉO (NASH) ===
    // ==================================================================

    // --- SUBSTITUIR FUN√á√ÉO calculatePlayerPower ---

function calculatePlayerPower(playerName) {
    // 1. Hierarquia (Baseado no N√≠vel Organizacional) [Source: 61]
    const li = Array.from(document.querySelectorAll('#player-list li')).find(i => i.dataset.name === playerName);
    if (!li) return 10; // Valor base
    
    // Converte n√≠vel "1.1" ou "2" em pontua√ß√£o. Menos pontos (n√≠vel mais alto) = Mais poder invertido
    // Assumindo n√≠veis de 1 (CEO) a 5 (Analista).
    const levelStr = li.dataset.level || "5"; 
    const levelVal = parseFloat(levelStr) || 5;
    // Hierarquia pesa at√© 50 pontos (CEO=50, Jr=10)
    const hierarchyScore = Math.max(10, 60 - (levelVal * 10)); 

    // 2. Influ√™ncia (Soma das conex√µes de entrada ponderadas)
    // "Quem influencia Quem + Grau 1-5" [Source: 57]
    let influenceScore = 0;
    influenceLinks.forEach(l => { 
        if(l.from === playerName) {
            // Se eu influencio algu√©m, ganho poder proporcional √† for√ßa
            influenceScore += (l.strength * 4); 
        }
    });

    // 3. Compet√™ncia (Dom√≠nio T√©cnico no Contexto) [Source: 62]
    let competenceScore = 0;
    const prof = globalPlayerProfiles[playerName];
    if (prof && prof.mastery) {
        // Usa a maior compet√™ncia como proxy de poder pessoal
        const maxSkill = Math.max(prof.mastery.tech || 0, prof.mastery.biz || 0, prof.mastery.lead || 0);
        competenceScore = maxSkill * 3; // Peso 3
    }

    // Soma da Heur√≠stica [Source: 61]
    return hierarchyScore + influenceScore + competenceScore;
}

   // --- SUBSTITUIR A FUN√á√ÉO renderNetworkGraph INTEIRA ---

window.renderNetworkGraph = () => {
    const noteId = document.getElementById('game-context-select').value;
    const container = document.getElementById('network-graph');
    
    // Valida√ß√£o
    if(!noteId || noteId.length < 5 || !noteId.startsWith('postit')) {
            container.innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:#a0aec0;">Selecione um objeto de disputa acima para gerar o grafo.</div>';
            return;
    }

    // 1. Recupera Contexto (Tech, Biz, Lead)
    const noteItem = canvasItems.find(i => i.id === noteId);
    const sectionId = noteItem ? noteItem.sectionId.replace('grid-','') : 'tech';
    const contextType = CONTEXT_MAPPING[sectionId] || 'tech';
    
    // 2. Prepara N√≥s (Players)
    const players = Array.from(document.querySelectorAll('#player-list li')).map(li => li.dataset.name);
    let nodes = [];
    
    players.forEach(p => {
        const power = calculatePlayerPower(p);
        const prof = globalPlayerProfiles[p] || {};
        const mastery = (prof.mastery && prof.mastery[contextType]) || 1; 
        
        nodes.push({ 
            id: p, 
            label: p, 
            value: power, 
            borderWidth: mastery, 
            borderWidthSelected: mastery + 2,
            color: { background: '#EDF2F7', border: '#2D3748', highlight:{background:'#4FD1C5', border:'#2D3748'} },
            title: `Poder: ${power}\nExpertise (${contextType}): ${mastery}/10`
        });
    });

    // 3. Prepara Arestas (Influ√™ncia)
    let edges = influenceLinks.map(l => ({ 
        from: l.from, 
        to: l.to, 
        width: l.strength, 
        arrows: 'to', 
        color: { color: '#CBD5E0', highlight: '#4FD1C5' } 
    }));
    
    // 4. Renderiza Vis.js
    if(networkInstance) networkInstance.destroy();
    container.innerHTML = ''; 

    const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
    
    const options = { 
        height: '100%', 
        width: '100%',
        physics: { stabilization: false }, 
        interaction: { 
            hover: true, 
            selectConnectedEdges: false,
            multiselect: true // Habilita suporte nativo (fallback)
        }, 
        nodes: { shape: 'dot', font: { size: 14, color: '#2D3748' } } 
    };

    networkInstance = new vis.Network(container, data, options);
    
    // [CORRE√á√ÉO] L√≥gica Manual de Sele√ß√£o (Click Simples)
    // Permite clicar em um, depois no outro, sem precisar segurar Ctrl
    let selectedNodeIds = [];

    networkInstance.on("click", function (params) {
        const clickedNode = params.nodes[0];
        
        if (clickedNode) {
            // Se o n√≥ j√° estava selecionado, remove (toggle)
            if (selectedNodeIds.includes(clickedNode)) {
                selectedNodeIds = selectedNodeIds.filter(id => id !== clickedNode);
            } else {
                // Adiciona o novo n√≥
                selectedNodeIds.push(clickedNode);
                // Mant√©m apenas os 2 √∫ltimos clicados (Fila FIFO)
                if (selectedNodeIds.length > 2) selectedNodeIds.shift();
            }
            
            // For√ßa a sele√ß√£o visual no grafo
            networkInstance.selectNodes(selectedNodeIds);

            // Se tivermos exatamente 2 selecionados, dispara a simula√ß√£o
            if (selectedNodeIds.length === 2) {
                document.getElementById('player-a-select').value = selectedNodeIds[0];
                document.getElementById('player-b-select').value = selectedNodeIds[1];
                
                const nashPanel = document.getElementById('nash-calculator-section');
                nashPanel.style.opacity = '1';
                nashPanel.style.pointerEvents = 'auto';
                
                autoAdjustGamePayoffs();
            }
        } else {
            // Clicou fora (no fundo): limpa sele√ß√£o
            selectedNodeIds = [];
            networkInstance.unselectAll();
            
            // Opcional: Esconder painel lateral se desejar
            // document.getElementById('nash-calculator-section').style.opacity = '0.6';
            // document.getElementById('nash-calculator-section').style.pointerEvents = 'none';
        }
    });
};
  
// [L√ìGICA AJUSTADA] Motor de Realismo Pol√≠tico (Cynical Tuning)
// Premissa: Em ambientes sens√≠veis, a n√£o-coopera√ß√£o √© o padr√£o.
// A coopera√ß√£o s√≥ emerge se o Interesse (Vantagem Pessoal) for alto o suficiente para vencer o Custo e a Tenta√ß√£o.

// Listener para atualizar o valor visual do slider em tempo real
document.getElementById('politicization-level').addEventListener('input', (e) => {
    document.getElementById('politicization-val').innerText = e.target.value + '%';
    // Se j√° houver simula√ß√£o rodando, recalcula em tempo real
    if(document.getElementById('player-a-select').value) {
        window.autoAdjustGamePayoffs();
    }
});

// [MOTOR AJUSTADO v6] Nash Tuning: Balanceamento Interesse vs Poder
window.autoAdjustGamePayoffs = () => {
    const pA = document.getElementById('player-a-select').value;
    const pB = document.getElementById('player-b-select').value;
    const noteId = document.getElementById('game-context-select').value;
    
    // Fator de Politiza√ß√£o (0.0 a 1.0)
    const pFactor = parseInt(document.getElementById('politicization-level').value) / 100;

    if (!pA || !pB || !noteId) return;

    // Recupera contexto
    const noteItem = canvasItems.find(i => i.id === noteId);
    const sectionId = noteItem ? noteItem.sectionId.replace('grid-', '') : 'tech';
    const contextType = CONTEXT_MAPPING[sectionId] || 'tech';
    
    // Recupera perfis
    const profA = globalPlayerProfiles[pA] || { mastery: {}, interestScore: 0 };
    const profB = globalPlayerProfiles[pB] || { mastery: {}, interestScore: 0 };

    // --- NORMALIZA√á√ÉO DE ATRIBUTOS (1 a 5) ---
    
    // 1. Interesse (Baseado na frequ√™ncia de men√ß√µes e payoffs)
    // Se o interesse √© alto, a pessoa QUER que aconte√ßa.
    let maxInterest = 1;
    Object.values(globalPlayerProfiles).forEach(p => {
        if((p.interestScore || 0) > maxInterest) maxInterest = p.interestScore;
    });
    const getNormInterest = (raw) => Math.ceil((raw / maxInterest) * 5) || 1;
    const intA = getNormInterest(profA.interestScore || 0);
    const intB = getNormInterest(profB.interestScore || 0);

    // 2. Poder (Hierarquia + Influ√™ncia)
    // O poder define a capacidade de impor vontade (Tenta√ß√£o DC)
    const powerA = Math.max(1, Math.min(5, Math.ceil(((profA.mastery && profA.mastery[contextType]) || 0) / 2)));
    const powerB = Math.max(1, Math.min(5, Math.ceil(((profB.mastery && profB.mastery[contextType]) || 0) / 2)));

    // 3. Compet√™ncia Geral (M√©dia do Tri√¢ngulo PMI)
    // Pessoas competentes tendem a valorizar a execu√ß√£o (CC)
    const getComp = (p) => {
        if(!p.mastery) return 1;
        return ( (p.mastery.tech||0) + (p.mastery.biz||0) + (p.mastery.lead||0) ) / 30 * 5; // 0-5
    };
    const compA = getComp(profA);
    const compB = getComp(profB);

    const clamp = (val) => Math.max(-5, Math.min(5, Math.round(val)));

    // --- C√ÅLCULO DOS PAYOFFS (A L√≥gica Corrigida) ---

    // Custos Ambientais
    // Se o ambiente √© hostil (pFactor alto), cooperar custa "energia" (desconfian√ßa)
    const friction = 2 * pFactor; 

    // 1. CC (Coopera√ß√£o M√∫tua): Interesse + Compet√™ncia - Fric√ß√£o
    // Se tenho muito interesse e sou competente, quero CC.
    const U_A_CC = clamp( (intA * 1.2) + (compA * 0.5) - friction );
    const U_B_CC = clamp( (intB * 1.2) + (compB * 0.5) - friction );

    // 2. DC (Tenta√ß√£o): Poder + Ganho de Curto Prazo
    // Se tenho muito poder, a tenta√ß√£o de mandar (e o outro obedecer) √© alta.
    // Mas se o ambiente for MUITO pol√≠tico, trair pode ser perigoso (retalia√ß√£o).
    const U_A_DC = clamp( 3 + (powerA * 0.8) - (friction * 0.5) ); 
    const U_B_DC = clamp( 3 + (powerB * 0.8) - (friction * 0.5) );

    // 3. CD (Pagamento de Ot√°rio): O quanto d√≥i ser tra√≠do?
    // Se tenho poder, d√≥i muito no ego ser enganado (-5). Se tenho pouco poder, j√° espero (-2).
    const U_A_CD = clamp( -2 - (powerA * 0.6) );
    const U_B_CD = clamp( -2 - (powerB * 0.6) );

    // 4. DD (In√©rcia/Travamento): 
    // AQUI ESTAVA O ERRO. A in√©rcia n√£o pode ser 0 ou confort√°vel se o Interesse √© alto.
    // Se eu tenho alto Interesse no projeto, DD deve ser DOLOROSO (negativo).
    // In√©rcia = -1 * Interesse (Quanto mais eu quero, mais sofro se nada acontecer).
    const U_A_DD = clamp( -1 * intA );
    const U_B_DD = clamp( -1 * intB );

    // Aplica nos Sliders
    setSlider('p1-cc', U_A_CC); setSlider('p2-cc', U_B_CC);
    setSlider('p1-cd', U_A_CD); setSlider('p2-cd', U_B_DC); // Cruzado
    setSlider('p1-dc', U_A_DC); setSlider('p2-dc', U_B_CD); // Cruzado
    setSlider('p1-dd', U_A_DD); setSlider('p2-dd', U_B_DD);

    // Dispara simula√ß√£o visual
    document.getElementById('calculate-nash-btn').click();
};
function inducedGameWithReputation(baseGame, context, playerA, playerB) {
  const repA = reputationStore[playerA]?.score || 0;
  const repB = reputationStore[playerB]?.score || 0;

  const game = {};

  ['C','D'].forEach(a => {
    ['C','D'].forEach(b => {
      const mech = mechanismWithReputation(a, b, context, repA, repB);

      game[a+b] = {
        A: baseGame[a+b].A + mech.A,
        B: baseGame[a+b].B + mech.B
      };
    });
  });

  return game;
}

const REPUTATION_WEIGHT = 0.5;

function applyReputation(value, rep) {
  return value * (1 + REPUTATION_WEIGHT * rep);
}

function mechanismWithReputation(sA, sB, context, repA, repB) {
  let TA = 0;
  let TB = 0;

  if (sA === 'C' && sB === 'C') {
    TA = applyReputation(context.coopBonus, repA);
    TB = applyReputation(context.coopBonus, repB);
  }
  else if (sA === 'D' && sB === 'C') {
    TA = applyReputation(-context.defectPenalty, repA);
  }
  else if (sA === 'C' && sB === 'D') {
    TB = applyReputation(-context.defectPenalty, repB);
  }
  else {
    TA = -context.inertiaCost;
    TB = -context.inertiaCost;
  }

  return {
    A: Math.round(TA),
    B: Math.round(TB)
  };
}
    function setSlider(id, val) {
        val = Math.max(-5, Math.min(5, val));
        document.getElementById(id).value = val;
        document.getElementById('val-'+id).innerText = val;
    }
    document.querySelectorAll('input[type="range"]').forEach(input => {
        input.addEventListener('input', (e) => { document.getElementById('val-' + e.target.id).innerText = e.target.value; });
    });

   // [CORRE√á√ÉO] C√°lculo Final de Nash (Com Ajuste de Avers√£o ao Risco)
            const btnSimular = document.getElementById('calculate-nash-btn');
            
            if (btnSimular) {
                btnSimular.addEventListener('click', () => {
                    // Seletores diretos para evitar erro de "not defined"
                    const selA = document.getElementById('player-a-select');
                    const selB = document.getElementById('player-b-select');
                    const containerMatriz = document.getElementById('matrix-container');
                    const divExplicacao = document.getElementById('nash-explanation');

                    const pA = selA ? (selA.value || "Jogador A") : "Jogador A";
                    const pB = selB ? (selB.value || "Jogador B") : "Jogador B";

                    // Pega valores dos Sliders
                    const uA_cc = parseInt(document.getElementById('p1-cc').value);
                    const uB_cc = parseInt(document.getElementById('p2-cc').value);
                    const uA_cd = parseInt(document.getElementById('p1-cd').value); 
                    const uB_cd = parseInt(document.getElementById('p2-cd').value);
                    const uA_dc = parseInt(document.getElementById('p1-dc').value); 
                    const uB_dc = parseInt(document.getElementById('p2-dc').value);
                    const uA_dd = parseInt(document.getElementById('p1-dd').value);
                    const uB_dd = parseInt(document.getElementById('p2-dd').value);

                    // L√ìGICA: Avers√£o ao Risco ( > em vez de >= )
                    // Melhores Respostas Jogador A
                    const brA_C = uA_cc > uA_dc ? 'C' : 'D'; 
                    const brA_D = uA_cd > uA_dd ? 'C' : 'D'; 
                    
                    // Melhores Respostas Jogador B
                    const brB_C = uB_cc > uB_cd ? 'C' : 'D'; 
                    const brB_D = uB_dc > uB_dd ? 'C' : 'D'; 

                    // Identifica Interse√ß√µes (Equil√≠brios)
                    const isNashCC = (brA_C === 'C' && brB_C === 'C');
                    const isNashCD = (brA_D === 'C' && brB_C === 'D'); 
                    const isNashDC = (brA_C === 'D' && brB_D === 'C'); 
                    const isNashDD = (brA_D === 'D' && brB_D === 'D');

                    let html = `
                        <div class="payoff-matrix">
                            <div class="matrix-header"></div>
                            <div class="matrix-header">${pB} Cooperar</div>
                            <div class="matrix-header">${pB} Resistir</div>
                            
                            <div class="matrix-header">${pA}<br>Cooperar</div>
                            <div class="matrix-cell ${isNashCC ? 'nash-equilibrium' : ''}">
                                ${isNashCC ? '<div class="nash-badge">NASH</div>' : ''}
                                <strong>${uA_cc}, ${uB_cc}</strong><br><small>Coopera√ß√£o M√∫tua</small>
                            </div>
                            <div class="matrix-cell ${isNashCD ? 'nash-equilibrium' : ''}">
                                ${isNashCD ? '<div class="nash-badge">NASH</div>' : ''}
                                <strong>${uA_cd}, ${uB_cd}</strong><br><small>${pA} Perde</small>
                            </div>

                            <div class="matrix-header">${pA}<br>Resistir</div>
                            <div class="matrix-cell ${isNashDC ? 'nash-equilibrium' : ''}">
                                ${isNashDC ? '<div class="nash-badge">NASH</div>' : ''}
                                <strong>${uA_dc}, ${uB_dc}</strong><br><small>${pB} Perde</small>
                            </div>
                            <div class="matrix-cell ${isNashDD ? 'nash-equilibrium' : ''}">
                                ${isNashDD ? '<div class="nash-badge">NASH</div>' : ''}
                                <strong>${uA_dd}, ${uB_dd}</strong><br><small>Travamento</small>
                            </div>
                        </div>
                    `;

                    if (containerMatriz) containerMatriz.innerHTML = html;
                    
                    let explanation = "<strong>Diagn√≥stico:</strong> ";
                    if (isNashDD && !isNashCC) {
                        explanation += "O sistema tende √† In√©rcia (Travamento). Sem novos incentivos, ningu√©m se mover√°.";
                    } else if (isNashCC && !isNashDD) {
                        explanation += "O cen√°rio favorece fortemente a Coopera√ß√£o.";
                    } else if (isNashDD && isNashCC) {
                        explanation += "Jogo de Coordena√ß√£o (Risco Alto). Embora cooperar seja poss√≠vel, o medo da trai√ß√£o deve empurrar para o Travamento.";
                    } else {
                        explanation += "Cen√°rio Assim√©trico (Domina√ß√£o ou Explora√ß√£o).";
                    }
                    
                    if (divExplicacao) {
                        divExplicacao.innerHTML = explanation;
                        divExplicacao.style.display = 'block';
                    }
                    
                    // Atualiza altura do acorde√£o se a fun√ß√£o existir
                    if(typeof updateAccordionHeight === 'function' && containerMatriz) {
                        updateAccordionHeight(containerMatriz.closest('.phase-content'));
                    }
                });
            }
			
    // ==================================================================
    // === FASE 4: ESTRAT√âGIA (COM MENU DE T√ÅTICAS RECUPERADO) ===
    // ==================================================================

    // [MOTOR] Sugest√£o T√°tica
    window.applyTactic = function(index, text) {
        const textarea = document.getElementById(`strategy-text-${index}`);
        if (textarea.value.length > 5) {
            if(confirm("Substituir texto atual?")) textarea.value = text;
            else textarea.value += "\n\n" + text;
        } else textarea.value = text;
        criticalScenarios[index].strategy = textarea.value;
    };
	
	// --- FUN√á√ÉO DE EXCLUS√ÉO SEGURA ---
window.deleteStrategy = function(index) {
    // Pergunta de seguran√ßa para evitar cliques acidentais
    if (confirm("Tem certeza que deseja excluir esta estrat√©gia permanentemente?")) {
        // Remove o item do array global
        criticalScenarios.splice(index, 1);
        // For√ßa a re-renderiza√ß√£o da tela
        renderStrategyPhase();
    }
};

    window.renderStrategyPhase = () => {
    const dash = document.getElementById('strategy-dashboard');
    dash.innerHTML = '';
    
    // Verifica se h√° cen√°rios
    if(criticalScenarios.length === 0) {
        dash.innerHTML = '<div id="empty-strategy-msg" style="text-align:center; padding:50px; color:#a0aec0; border: 2px dashed #e2e8f0; border-radius:8px;"><h3>Nenhuma estrat√©gia salva</h3><p>Realize as simula√ß√µes na Fase 3 primeiro.</p></div>';
        return;
    }
    
    criticalScenarios.forEach((s, i) => {
        const noteItem = canvasItems.find(it => it.id === s.contextId);
        const section = noteItem ? noteItem.sectionId : '';
        const sectionEl = document.getElementById(section);
        const payoffType = sectionEl ? sectionEl.dataset.payoffType : 'Geral';
        
        // Popula Dropdown com STRATEGY_TACTICS
        const tactics = STRATEGY_TACTICS[payoffType] || STRATEGY_TACTICS['Geral'];
        const optionsHTML = tactics.map(t => `<option value="${t.text.replace(/"/g, '&quot;')}">${t.label}</option>`).join('');

        const card = document.createElement('div');
        card.className = 'tool-card';
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h5>${s.contextName} (${s.playerA} vs ${s.playerB}) <span style="font-size:0.7em; background:#eee; padding:2px 5px; border-radius:4px;">${payoffType}</span></h5>
                
                <button onclick="deleteStrategy(${i})" style="color:white; background:#F56565; border:none; border-radius:4px; padding:5px 10px; cursor:pointer; font-weight:bold; font-size:0.8rem;">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </div>
            
            <p style="font-size:0.85rem; background:#f7fafc; padding:8px; border-left: 3px solid #cbd5e0; margin-top:10px;">
                <strong>Diagn√≥stico:</strong> ${s.diagnosis}
            </p>
            
            <div style="margin-top:10px; margin-bottom:5px;">
                <select onchange="applyTactic(${i}, this.value)" style="font-size:0.85rem; padding:5px; background:#f0fff4; border:1px solid #9ae6b4; width:100%; border-radius:4px;">
                    <option value="">üí° Sugest√µes T√°ticas para ${payoffType}...</option>
                    ${optionsHTML}
                </select>
            </div>
            
            <textarea id="strategy-text-${i}" placeholder="Descreva sua estrat√©gia..." 
                oninput="criticalScenarios[${i}].strategy = this.value" 
                style="width:100%; min-height:80px; padding:10px; border:1px solid #e2e8f0; border-radius:4px;">${s.strategy || ''}</textarea>
        `;
        dash.appendChild(card);
    });
};

   // [CORRE√á√ÉO] Salvar Estrat√©gia com SNAPSHOT da Matriz
    document.getElementById('save-to-strategy-btn').onclick = () => {
        const contextId = document.getElementById('game-context-select').value;
        
        // Fun√ß√£o auxiliar para pegar valor num√©rico dos sliders
        const val = (id) => parseInt(document.getElementById(id).value) || 0;

        // Cria o "Snapshot" (Foto exata) da matriz atual
        const currentMatrixSnapshot = {
            CC: { A: val('p1-cc'), B: val('p2-cc') },
            CD: { A: val('p1-cd'), B: val('p2-cd') },
            DC: { A: val('p1-dc'), B: val('p2-dc') },
            DD: { A: val('p1-dd'), B: val('p2-dd') }
        };

        const scen = {
            playerA: document.getElementById('player-a-select').value,
            playerB: document.getElementById('player-b-select').value,
            contextId: contextId,
            contextName: document.getElementById('game-context-select').options[document.getElementById('game-context-select').selectedIndex].text,
            diagnosis: document.getElementById('nash-explanation').innerText,
            strategy: '',
            // AQUI EST√Å A CHAVE: Salvamos a matriz exata para usar na auditoria depois
            originalMatrix: currentMatrixSnapshot
        };

        criticalScenarios.push(scen);
        renderStrategyPhase();
        alert("Cen√°rio salvo na Fase 4 com os valores exatos da simula√ß√£o!");
    };

    // ==================================================================
    // === FASE 5: IMPLEMENTA√á√ÉO & RELAT√ìRIO PROFISSIONAL ===
    // ==================================================================

    document.getElementById('sync-strategies-btn').onclick = () => {
         if(criticalScenarios.length === 0) { alert("Nada para importar."); return; }
         criticalScenarios.forEach(s => {
             if(!implementationData.some(d => d.contextName === s.contextName && d.playerA === s.playerA)) {
                 implementationData.push({ ...s, round: 0, result: 'pending' });
             }
         });
         renderImplementationBoard();
         alert("Estrat√©gias importadas para o Backlog!");
    };
	function registerReputation(player, action) {
  if (!reputationStore[player]) {
    reputationStore[player] = { coop: 0, defect: 0, score: 0 };
  }

  if (action === 'success') reputationStore[player].coop++;
  if (action === 'fail') reputationStore[player].defect++;

  const total =
    reputationStore[player].coop +
    reputationStore[player].defect;

  reputationStore[player].score =
    total === 0 ? 0 :
    (reputationStore[player].coop - reputationStore[player].defect) / total;
}

    window.renderImplementationBoard = () => {
    ['list-backlog', 'list-round1', 'list-round2', 'list-round3'].forEach(id => document.getElementById(id).innerHTML = '');
    
    if (implementationData.length === 0) return;

    implementationData.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'action-card';
        
        let statusBadge = '<span class="status-badge status-pending">Pendente</span>';
        if(item.result === 'success') statusBadge = '<span class="status-badge status-success">Cooperou</span>';
        if(item.result === 'fail') statusBadge = '<span class="status-badge status-fail">Resistiu</span>';

        // Adicionei o bot√£o de excluir (X) no topo direito
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:flex-start;">
                ${statusBadge}
                <div style="text-align:right;">
                    <div style="font-size:0.75rem;">${item.playerA} vs ${item.playerB}</div>
                    <button onclick="deleteImplementationItem(${idx})" style="color:#cbd5e0; background:none; border:none; cursor:pointer; font-size:0.8rem; margin-top:2px;" title="Remover da Fase 5">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px;">${item.contextName}</div>
            <div style="font-size:0.8rem; color:#4a5568; margin-bottom:10px;">${item.strategy ? item.strategy.substring(0,50)+'...' : 'Sem estrat√©gia'}</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                ${item.round > 0 ? `<button onclick="moveItem(${idx}, -1)" style="cursor:pointer; border:none; background:none;">‚¨ÖÔ∏è</button>` : '<span></span>'}
                <div>
                    <button onclick="setResult(${idx}, 'success')" style="border:1px solid green; background:white; cursor:pointer; border-radius:3px; opacity: ${item.result==='success'?1:0.3}">üëç</button>
                    <button onclick="setResult(${idx}, 'fail')" style="border:1px solid red; background:white; cursor:pointer; border-radius:3px; opacity: ${item.result==='fail'?1:0.3}">üëé</button>
                </div>
                ${item.round < 3 ? `<button onclick="moveItem(${idx}, 1)" style="cursor:pointer; border:none; background:none;">‚û°Ô∏è</button>` : '<span></span>'}
            </div>
        `;
        
        let target = 'list-backlog';
        if(item.round === 1) target = 'list-round1';
        if(item.round === 2) target = 'list-round2';
        if(item.round === 3) target = 'list-round3';
        
        const el = document.getElementById(target);
        if(el) el.appendChild(card);
    });
};

    window.moveItem = (idx, dir) => { implementationData[idx].round += dir; renderImplementationBoard(); };
   window.setResult = (idx, res) => {
    // Apenas atualiza o estado do dado
    implementationData[idx].result = res;
    
    // Atualiza a visualiza√ß√£o dos cards
    renderImplementationBoard();
    
    // Recalcula toda a hist√≥ria baseada no estado atual
    recalculateAllReputation();
};

    function drawReputationChart() {
        const container = document.getElementById('reputation-chart-container');
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Jogador'); data.addColumn('number', 'Confiabilidade (%)'); data.addColumn({type: 'string', role: 'style'});
        let hasData = false;
        Object.keys(playerReputationHistory).forEach(p => {
            const h = playerReputationHistory[p];
            if(h.total > 0) {
                hasData = true;
                const score = (h.coop / h.total) * 100;
                const color = score > 70 ? '#48BB78' : (score > 40 ? '#ECC94B' : '#F56565');
                data.addRow([p, score, color]);
            }
        });
        if(!hasData) container.innerHTML = '<p style="text-align:center; color:#a0aec0;">Sem hist√≥rico de rounds.</p>';
        else new google.visualization.BarChart(container).draw(data, { title: '√çndice de Coopera√ß√£o', legend: { position: "none" } });
    }
	
	// --- FUN√á√ÉO PARA EXCLUIR CARD DA FASE 5 ---
window.deleteImplementationItem = function(index) {
    if(confirm("Remover este item da implementa√ß√£o? A reputa√ß√£o ser√° recalculada desconsiderando esta a√ß√£o.")) {
        // Remove do array
        implementationData.splice(index, 1);
        
        // Renderiza o quadro novamente
        renderImplementationBoard();
        
        // Recalcula a reputa√ß√£o (o item exclu√≠do deixar√° de contar)
        recalculateAllReputation();
    }
};
	// --- FUN√á√ÉO DE REC√ÅLCULO DIN√ÇMICO (NOVA) ---
function recalculateAllReputation() {
    // 1. Zera o hist√≥rico global
    playerReputationHistory = {};

    // 2. Varre apenas os dados ativos na Fase 5
    implementationData.forEach(item => {
        // S√≥ conta se tiver resultado definido (success ou fail)
        if (item.result === 'success' || item.result === 'fail') {
            const pB = item.playerB;
            
            // Inicializa se n√£o existir
            if (!playerReputationHistory[pB]) {
                playerReputationHistory[pB] = { coop: 0, total: 0 };
            }

            // Soma totais
            playerReputationHistory[pB].total++;
            if (item.result === 'success') {
                playerReputationHistory[pB].coop++;
            }
        }
    });

    // 3. Atualiza o gr√°fico visualmente
    drawReputationChart();
    
    // 4. (Opcional) Se estiver na tela da Fase 6, atualiza ela tamb√©m
    const phase6 = document.getElementById('view-phase6');
    if (phase6 && phase6.classList.contains('active')) {
        renderPhase6Comparison(); 
    }
}

    // --- GERADOR DE RELAT√ìRIO PROFISSIONAL (ATUALIZADO V2.0) ---
            const exportReportBtn = document.getElementById('export-report-btn');
            
            if (exportReportBtn) {
                exportReportBtn.addEventListener('click', () => {
                    // Valida√ß√£o b√°sica
                    if (criticalScenarios.length === 0 && implementationData.length === 0) {
                        alert("O relat√≥rio est√° vazio. Crie estrat√©gias na Fase 4 ou execute Rounds na Fase 5.");
                        return;
                    }

                    const reportContainer = document.getElementById('printable-report');
                    const projectName = document.getElementById('project-name-input').value || "Projeto Sem Nome";
                    const date = new Date().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });

                    // --- C√ÅLCULOS ESTAT√çSTICOS PARA O SUM√ÅRIO ---
                    const totalStrategies = criticalScenarios.length;
                    const totalActions = implementationData.length;
                    const successCount = implementationData.filter(i => i.result === 'success').length;
                    const successRate = totalActions > 0 ? Math.round((successCount / totalActions) * 100) : 0;

                    // 1. CAPA DO RELAT√ìRIO
                    let htmlContent = `
                        <div class="report-cover">
                            <h1 class="report-title">PLANO ESTRAT√âGICO DE IMPLEMENTA√á√ÉO</h1>
                            <p class="report-subtitle">Projeto: ${projectName}</p>
                            <br><br>
                            <div style="border: 1px solid #000; padding: 20px; width: 60%;">
                                <p><strong>STATUS: IMPLEMENTA√á√ÉO EM CURSO</strong></p>
                                <p>Taxa de Sucesso Atual: <strong>${successRate}%</strong></p>
                                <p>Rounds Executados: <strong>${totalActions}</strong></p>
                            </div>
                            <br><br>
                            <p><strong>Documento Confidencial de Apoio √† Decis√£o</strong></p>
                            <p>Gerado pelo Framework PLAYS 1.1</p>
                            <br><br>
                            <p style="font-size: 10pt;">Data de Emiss√£o: ${date}</p>
                        </div>
                    `;

                    // 2. SUM√ÅRIO EXECUTIVO
                    htmlContent += `
                        <div class="report-header">
                            <strong>PLAYS Report</strong> - ${projectName}
                        </div>
                        <h1>1. Sum√°rio Executivo</h1>
                        <p>O presente documento detalha a estrat√©gia de articula√ß√£o pol√≠tica e institucional para a viabiliza√ß√£o do projeto <strong>${projectName}</strong>. Foram identificados <strong>${totalStrategies} n√≥s cr√≠ticos</strong> que requerem interven√ß√£o direta.</p>
                        <p>At√© o momento, foram realizadas <strong>${totalActions} a√ß√µes t√°ticas</strong> em ciclos de implementa√ß√£o (Rounds), com uma taxa de convers√£o de coopera√ß√£o de ${successRate}%.</p>
                    `;

                    // 3. METODOLOGIA (NOVO BLOCO - ADICIONADO)
                    htmlContent += `
                        <h1>2. Metodologia de C√°lculo e Diagn√≥stico</h1>
                        <p>A defini√ß√£o dos equil√≠brios estrat√©gicos baseou-se no algoritmo do framework PLAYS, utilizando as seguintes vari√°veis:</p>
                        
                        <h3>2.1. C√°lculo de Poder (Power Score)</h3>
                        <p>O poder de cada jogador (P) foi calculado pela f√≥rmula: <strong>P = Hierarquia + Influ√™ncia + Compet√™ncia</strong>.</p>
                        <ul>
                            <li><strong>Hierarquia:</strong> Baseada no n√≠vel funcional cadastrado.</li>
                            <li><strong>Influ√™ncia:</strong> Somat√≥ria dos links de patroc√≠nio e conex√µes pol√≠ticas mapeadas.</li>
                            <li><strong>Compet√™ncia:</strong> An√°lise de curr√≠culos via keywords (Tech/Biz/Lead).</li>
                        </ul>

                        <h3>2.2. Teoria dos Jogos</h3>
                        <p>Os cen√°rios foram diagnosticados buscando o <strong>Equil√≠brio de Nash</strong>. Interven√ß√µes foram desenhadas para transformar jogos de soma zero (travamento) em jogos de coordena√ß√£o (coopera√ß√£o), alterando os payoffs de <em>Poder, Status, Seguran√ßa, Recursos ou Autonomia</em>.</p>
                    `;

                    // 4. MATRIZ DE ESTRAT√âGIA (FASE 4)
                    htmlContent += `<h1>3. Matriz de Interven√ß√£o Estrat√©gica (Planejado)</h1>`;

                    if (criticalScenarios.length === 0) {
                        htmlContent += `<p><em>Nenhuma estrat√©gia definida na Fase 4.</em></p>`;
                    } else {
                        criticalScenarios.forEach((scen, index) => {
                            const strategyFormatted = scen.strategy ? scen.strategy.replace(/\n/g, '<br>') : "<em>Pendente de defini√ß√£o.</em>";
                            
                            htmlContent += `
                                <div class="report-section">
                                    <h2>3.${index + 1}. Conflito: ${scen.contextName}</h2>
                                    <table class="doc-table">
                                        <tr>
                                            <th style="width: 30%;">Atores Envolvidos</th>
                                            <td>${scen.playerA} <span style="font-size:0.8em">vs</span> ${scen.playerB}</td>
                                        </tr>
                                        <tr>
                                            <th>Objeto de Disputa</th>
                                            <td>${scen.payoffType}</td>
                                        </tr>
                                    </table>

                                    <div class="box-diagnosis">
                                        <strong>Diagn√≥stico:</strong> ${scen.diagnosis}
                                    </div>

                                    <div class="box-strategy">
                                        <strong>Plano de A√ß√£o (Mechanism Design):</strong><br>
                                        ${strategyFormatted}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // 5. RESULTADOS DA IMPLEMENTA√á√ÉO (NOVO BLOCO - EXTRA√çDO DA FASE 5)
                    htmlContent += `<h1>4. Resultados da Implementa√ß√£o (Executado)</h1>`;
                    
                    if (implementationData.length === 0) {
                         htmlContent += `<p><em>Nenhuma a√ß√£o registrada na Fase 5 (Implementa√ß√£o).</em></p>`;
                    } else {
                        htmlContent += `
                            <p>Tabela consolidada dos ciclos de intera√ß√£o (Tit-for-Tat) e resposta dos stakeholders.</p>
                            <table class="doc-table">
                                <thead>
                                    <tr style="background-color: #eee;">
                                        <th style="width:10%">Round</th>
                                        <th style="width:25%">Contexto</th>
                                        <th style="width:20%">Atores</th>
                                        <th style="width:30%">Estrat√©gia/A√ß√£o</th>
                                        <th style="width:15%">Resultado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        implementationData.forEach(item => {
                            // Traduz o status
                            let statusLabel = 'Pendente';
                            let statusColor = '#666';
                            let rowBg = '#fff';

                            if (item.result === 'success') {
                                statusLabel = '‚úÖ SUCESSO<br><small>(Cooperou)</small>';
                                statusColor = 'green';
                                rowBg = '#f0fff4'; // Fundo verde claro para sucesso
                            } else if (item.result === 'fail') {
                                statusLabel = '‚ùå FALHA<br><small>(Resistiu)</small>';
                                statusColor = 'red';
                                rowBg = '#fff5f5'; // Fundo vermelho claro para falha
                            }

                            // Traduz o Round
                            let roundName = item.round === 0 ? 'Backlog' : `Round ${item.round}`;
                            if (item.round === 1) roundName += ' (Piloto)';

                            htmlContent += `
                                <tr style="background-color: ${rowBg};">
                                    <td style="text-align:center; font-weight:bold;">${roundName}</td>
                                    <td>${item.contextName}</td>
                                    <td>${item.playerA} vs ${item.playerB}</td>
                                    <td style="font-size:0.9em;">${item.strategy || '-'}</td>
                                    <td style="text-align:center; color:${statusColor}; font-weight:bold;">${statusLabel}</td>
                                </tr>
                            `;
                        });

                        htmlContent += `</tbody></table>`;
                    }
					// 6. AUDITORIA DE IMPACTO (VERS√ÉO CORRIGIDA PARA LISTA)
                    const auditList = document.getElementById('audit-list-container');
                    
                    // Verifica se a auditoria foi gerada (se o container existe e tem filhos)
                    if (auditList && auditList.children.length > 0) {
                        htmlContent += `
                            <div style="page-break-before: always;"></div>
                            <h1>6. Auditoria de Impacto (Nash Comparativo)</h1>
                            <p>Comparativo matem√°tico da estabilidade estrat√©gica antes e depois das interven√ß√µes (Fase 6).</p>
                            
                            <div style="margin-top:20px;">
                                ${auditList.innerHTML} 
                            </div>
                        `;
                    } else {
                        // Opcional: Avisar que a auditoria n√£o foi rodada
                         htmlContent += `
                            <div style="page-break-before: always;"></div>
                            <h1>6. Auditoria de Impacto</h1>
                            <p><em>Auditoria n√£o calculada. Execute a Fase 6 antes de gerar o relat√≥rio para ver os comparativos de Nash.</em></p>
                        `;
                    }


                    // 6. CONCLUS√ÉO / ASSINATURAS
                    htmlContent += `
                        <h1>5. Valida√ß√£o e Aprova√ß√£o</h1>
                        <br><br><br>
                        <table style="width: 100%; margin-top: 50px;">
                            <tr>
                                <td style="border-top: 1px solid #000; width: 45%; text-align: center; padding-top: 10px;">Gerente de Projeto</td>
                                <td style="width: 10%;"></td>
                                <td style="border-top: 1px solid #000; width: 45%; text-align: center; padding-top: 10px;">Sponsor Executivo</td>
                            </tr>
                        </table>
                    `;

                    // Injeta o HTML e Imprime
                    reportContainer.innerHTML = htmlContent;
                    window.print();
                });
            }

    // --- AUXILIARES GERAIS & INIT ---
    function updateGameDropdowns() {
        const players = Array.from(document.querySelectorAll('#player-list li')).map(li => li.dataset.name);
        const pOpts = '<option value="">Selecione...</option>' + players.map(p => `<option value="${p}">${p}</option>`).join('');
        document.getElementById('player-a-select').innerHTML = pOpts;
        document.getElementById('player-b-select').innerHTML = pOpts;
        if(document.getElementById('influencer-select')) {
            document.getElementById('influencer-select').innerHTML = pOpts;
            document.getElementById('influenced-select').innerHTML = pOpts;
        }
        const cOpts = '<option value="">Selecione Objeto de Disputa...</option>' + canvasItems.map(i => `<option value="${i.id}">${i.text.substring(0,40)}</option>`).join('');
        const ctxSelect = document.getElementById('game-context-select');
        if(ctxSelect) ctxSelect.innerHTML = cOpts;
    }

    const addPlayerBtn = document.getElementById('add-player-btn');
    if(addPlayerBtn) {
        addPlayerBtn.onclick = () => {
            const name = document.getElementById('player-name').value;
            const title = document.getElementById('player-title').value;
            const company = document.getElementById('player-company').value;
            const level = document.getElementById('player-level').value;
            if(!name) return alert("Nome obrigat√≥rio");
            const li = document.createElement('li');
            li.dataset.name = name; li.dataset.title = title; li.dataset.level = level; li.dataset.company = company;
            li.innerHTML = `<div style="background:white; padding:8px; border:1px solid #e2e8f0; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between;"><div><b>${name}</b> <span style="font-size:0.8em; color:#718096;">${title} (${level})</span></div><button onclick="this.parentElement.parentElement.remove(); updateGameDropdowns();" style="color:red; border:none; background:none; cursor:pointer;">√ó</button></div>`;
            document.getElementById('player-list').appendChild(li);
            updateGameDropdowns();
            drawOrgChart();
        };
    }

    function drawOrgChart() {
        const container = document.getElementById('chart-container');
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Name'); data.addColumn('string', 'Manager'); data.addColumn('string', 'ToolTip');
        const players = Array.from(document.querySelectorAll('#player-list li'));
        if(players.length === 0) { container.innerHTML = ''; return; }
        const levelMap = {}; players.forEach(li => levelMap[li.dataset.level] = li.dataset.name);
        players.forEach(li => {
            const lvl = li.dataset.level;
            const parentLvl = lvl.includes('.') ? lvl.substring(0, lvl.lastIndexOf('.')) : '';
            data.addRow([{ v: li.dataset.name, f: `<div><b>${li.dataset.name}</b><div style="color:#718096; font-style:italic;">${li.dataset.title}</div></div>` }, levelMap[parentLvl] || '', li.dataset.title]);
        });
        new google.visualization.OrgChart(container).draw(data, {allowHtml:true});
    }
    document.getElementById('generate-map-btn').onclick = drawOrgChart;

    document.getElementById('add-connection-btn').onclick = () => {
        const link = { from: document.getElementById('influencer-select').value, to: document.getElementById('influenced-select').value, strength: parseInt(document.getElementById('strength-input').value), dimension: document.getElementById('dimension-select').value };
        if(!link.from || !link.to || link.from === link.to) return alert("Selecione jogadores diferentes.");
        influenceLinks.push(link);
        const li = document.createElement('li');
        li.innerHTML = `${link.from} ‚ûî ${link.to} (${link.dimension}) <button onclick="this.parentElement.remove()" style="margin-left:10px; color:red; border:none; background:none;">√ó</button>`;
        document.getElementById('connection-list').appendChild(li);
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'De'); data.addColumn('string', 'Para'); data.addColumn('number', 'Peso');
        influenceLinks.forEach(l => data.addRow([l.from, l.to, l.strength]));
        new google.visualization.Sankey(document.getElementById('influenceChartContainer')).draw(data, { height: 200 });
    };

   // --- SUBSTITUIR O EVENTO DE CLICK DO BOT√ÉO SAVE ---

document.getElementById('save-btn').onclick = () => {
    // 1. Coleta dados da Fase 1 (DNA do Projeto)
    const phase1Data = {
        type: document.getElementById('dna-type').value,
        constraint: document.getElementById('dna-constraint').value,
        techTags: document.getElementById('project-tech-tags').value
    };

    // 2. Coleta Jogadores
    const playersList = Array.from(document.querySelectorAll('#player-list li')).map(li => ({
        name: li.dataset.name,
        title: li.dataset.title,
        company: li.dataset.company,
        level: li.dataset.level
    }));

    // 3. Links de Influ√™ncia
    const formattedLinks = influenceLinks.map(l => ({
        from: l.from,
        to: l.to,
        dimension: l.dimension,
        strength: l.strength
    }));

    // 4. Objeto Final Consolidado
    const projectData = {
        projectName: document.getElementById('project-name-input').value || "Novo Projeto",
        lastSaved: new Date().toISOString(), // Data para controle de vers√£o
        phase1Data: phase1Data,
        players: playersList,
        canvasItems: canvasItems, 
        notes: document.getElementById('payoff-notes').innerHTML, 
        links: formattedLinks,
        globalPlayerProfiles: globalPlayerProfiles, 
        
        // --- CR√çTICO PARA AUDITORIA ---
        // Salva as estrat√©gias e a "Matriz Original" (O cen√°rio ANTES da interven√ß√£o)
        criticalScenarios: criticalScenarios, 
        
        // --- CR√çTICO PARA REPUTA√á√ÉO ---
        // Salva o resultado dos rounds (Success/Fail). O score √© recalculado a partir disso.
        implementationData: implementationData, 
        
        // Salva estado visual da simula√ß√£o
        phase3State: {
            contextId: document.getElementById('game-context-select').value,
            playerA: document.getElementById('player-a-select').value,
            playerB: document.getElementById('player-b-select').value,
            sliders: {
                'p1-cc': document.getElementById('p1-cc').value,
                'p2-cc': document.getElementById('p2-cc').value,
                // ... (Opcional: salvar todos os sliders se desejar precis√£o visual extrema)
            }
        }
    };

    // Download do Arquivo
    const fileName = `PLAYS_${projectData.projectName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    const blob = new Blob([JSON.stringify(projectData, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
};

    document.getElementById('load-btn').onclick = () => document.getElementById('load-json-input').click();
    // [CORRE√á√ÉO] Carregamento Robusto de JSON (Paridade com PLAYS 1.0)
   document.getElementById('load-json-input').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
        try {
            const data = JSON.parse(evt.target.result);
            
            // --- RESTAURA√á√ÉO DE DADOS B√ÅSICOS ---
            document.getElementById('project-name-input').value = data.projectName || '';
            
            // Fase 1 & 2 (Jogadores, Canvas, Arquivos)
            if (data.phase1Data) {
                document.getElementById('dna-type').value = data.phase1Data.type || '';
                document.getElementById('dna-constraint').value = data.phase1Data.constraint || '';
                document.getElementById('project-tech-tags').value = data.phase1Data.techTags || '';
                if(window.checkProjectCoherence) window.checkProjectCoherence();
            }

            // Restaura Jogadores
            const pList = document.getElementById('player-list'); pList.innerHTML = '';
            if(data.players) {
                data.players.forEach(p => {
                    const li = document.createElement('li');
                    li.dataset.name = p.name; li.dataset.title = p.title; li.dataset.level = p.level; li.dataset.company = p.company;
                    li.innerHTML = `<div style="background:white; padding:8px; border:1px solid #e2e8f0; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between;"><div><b>${p.name}</b> <span style="font-size:0.8em; color:#718096;">${p.title} (${p.level})</span></div><button onclick="this.parentElement.parentElement.remove(); updateGameDropdowns();" style="color:red; border:none; background:none; cursor:pointer;">√ó</button></div>`;
                    pList.appendChild(li);
                });
            }

            // Restaura Notas e Arquivos
            if(data.notes) {
                document.getElementById('payoff-notes').innerHTML = data.notes;
                // (C√≥digo de reconstru√ß√£o da lista visual de arquivos permanece o mesmo do seu script atual)
            }

            // Dados Globais
            if(data.links) influenceLinks = data.links;
            if(data.globalPlayerProfiles) globalPlayerProfiles = data.globalPlayerProfiles;
            if(data.canvasItems) { canvasItems = data.canvasItems; renderAllPostIts(); }
            
            // --- RESTAURA√á√ÉO ESTRAT√âGICA (O PULO DO GATO) ---
            
            // 1. Restaura Cen√°rios Cr√≠ticos (Base para Auditoria)
            if(data.criticalScenarios) { 
                criticalScenarios = data.criticalScenarios; 
                renderStrategyPhase(); 
            }

            // 2. Restaura Implementa√ß√£o e RECALCULA REPUTA√á√ÉO
            if(data.implementationData) { 
                implementationData = data.implementationData; 
                renderImplementationBoard(); 
                
                // [IMPORTANTE] For√ßa o rec√°lculo imediato da reputa√ß√£o
                // Isso preenche a vari√°vel 'playerReputationHistory' usada na Fase 6
                recalculateAllReputation(); 
            }

            updateGameDropdowns();

            // 3. Restaura Estado da Simula√ß√£o Visual
            if (data.phase3State) {
                if (data.phase3State.playerA) document.getElementById('player-a-select').value = data.phase3State.playerA;
                if (data.phase3State.playerB) document.getElementById('player-b-select').value = data.phase3State.playerB;
                const ctxSelect = document.getElementById('game-context-select');
                if(ctxSelect && data.phase3State.contextId) {
                    ctxSelect.value = data.phase3State.contextId;
                }
            }

            // Atualiza Gr√°ficos
            google.charts.setOnLoadCallback(() => {
                drawOrgChart();
                if(influenceLinks.length > 0) {
                     // Redesenha Sankey se houver dados
                }
                // O gr√°fico de reputa√ß√£o j√° foi chamado dentro de recalculateAllReputation()
            });

            alert(`Projeto "${data.projectName}" carregado! Reputa√ß√£o e Auditoria sincronizadas.`);

        } catch (err) {
            console.error(err);
            alert("Erro ao ler JSON: " + err.message);
        }
    };
    reader.readAsText(file);
    e.target.value = ''; 
};

    const ctx = document.getElementById('game-context-select');
    if(ctx) ctx.addEventListener('change', window.renderNetworkGraph);
    updateGameDropdowns();
// ==================================================================
// === FASE 6: AUDITORIA DETALHADA POR DILEMA ===
// ==================================================================

window.renderPhase6Comparison = function() {
    const container = document.getElementById('view-phase6');
    const listContainer = document.getElementById('audit-list-container');
    
    // Se n√£o existir o container da lista ainda, cria a estrutura
    if (!listContainer) {
        // Limpa a view para reconstruir a estrutura correta
        const header = container.querySelector('.view-header').outerHTML;
        container.innerHTML = header + `
            <div class="tool-card" style="margin-top:20px; background:#ebf8ff; border-left:5px solid #2b6cb0;">
                <h5>üìä Relat√≥rio de Auditoria de Nash</h5>
                <p style="font-size:0.9rem;">Abaixo est√£o os dilemas tratados na Fase 5, comparando o equil√≠brio original (baseado em poder/interesse) com o novo equil√≠brio ap√≥s a constru√ß√£o de reputa√ß√£o.</p>
            </div>
            <div id="audit-list-container" style="margin-top:30px; display:flex; flex-direction:column; gap:40px;"></div>
        `;
    }

    const targetDiv = document.getElementById('audit-list-container');
    targetDiv.innerHTML = ''; // Limpa lista atual

    if (!implementationData || implementationData.length === 0) {
        targetDiv.innerHTML = '<div style="text-align:center; color:#a0aec0; padding:40px;">Nenhum dilema implementado na Fase 5 ainda. Execute os Rounds primeiro.</div>';
        return;
    }

    // Itera sobre cada item implementado na Fase 5
    implementationData.forEach((item, index) => {
        // 1. Recalcula o Jogo Original (Antes)
        // Usamos os perfis globais para estimar como era o jogo antes da reputa√ß√£o
        const pA = item.playerA;
        const pB = item.playerB;
        
        // 1. Recalcula o Jogo Original (Antes)
        let gameOld;

        // [CORRE√á√ÉO] Verifica se temos a "foto" original salva na Fase 3
        if (item.originalMatrix) {
            gameOld = item.originalMatrix;
        } else {
            // Fallback para projetos antigos (Recalcula baseado em heur√≠stica)
            gameOld = simulateOriginalGame(pA, pB, item.contextId);
        }

        // 2. Calcula o Jogo Novo (Depois) com Reputa√ß√£o Real
        const histA = playerReputationHistory[pA] || { coop: 0, total: 0 };
        const histB = playerReputationHistory[pB] || { coop: 0, total: 0 };
        const repScoreA = histA.total > 0 ? (histA.coop / histA.total) : 0;
        const repScoreB = histB.total > 0 ? (histB.coop / histB.total) : 0;
        const bonus = 4; // B√¥nus de Reputa√ß√£o

        const gameNew = {
            CC: { A: Math.min(5, gameOld.CC.A + Math.round(repScoreB * bonus)), B: Math.min(5, gameOld.CC.B + Math.round(repScoreA * bonus)) },
            CD: { A: gameOld.CD.A, B: gameOld.CD.B },
            DC: { A: gameOld.DC.A, B: gameOld.DC.B },
            DD: { A: Math.max(-5, gameOld.DD.A - Math.round(repScoreA * 1)), B: Math.max(-5, gameOld.DD.B - Math.round(repScoreB * 1)) }
        };

        // 3. Verifica Nash
        const nashOld = getNashState(gameOld);
        const nashNew = getNashState(gameNew);

        // 4. Cria o HTML do Card Comparativo
        const card = document.createElement('div');
        card.className = 'tool-card';
        card.style.borderTop = "4px solid #718096";
        
        // Determina cor do status
        let improvement = "neutro";
        if (nashOld !== 'CC' && nashNew === 'CC') improvement = "bom";
        if (nashOld === 'CC' && nashNew !== 'CC') improvement = "ruim";

        const statusColor = improvement === 'bom' ? '#48BB78' : (improvement === 'ruim' ? '#F56565' : '#4299E1');
        const statusText = improvement === 'bom' ? 'EVOLU√á√ÉO PARA COOPERA√á√ÉO' : (nashNew === 'CC' ? 'MANUTEN√á√ÉO DE COOPERA√á√ÉO' : 'CONFLITO PERSISTENTE');

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <div>
                    <h5 style="margin:0; font-size:1.1rem;">#${index+1} ${item.contextName}</h5>
                    <span style="font-size:0.8rem; color:#718096;">${pA} vs ${pB}</span>
                </div>
                <div style="text-align:right;">
                    <span style="background:${statusColor}; color:white; padding:4px 8px; border-radius:4px; font-size:0.75rem; font-weight:bold;">${statusText}</span>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 50px 1fr; gap:10px; align-items:center;">
                <div>
                    <h6 style="text-align:center; color:#F56565; margin-bottom:5px;">Cen√°rio Original</h6>
                    ${generateMiniMatrix(gameOld, pA, pB)}
                    <div style="text-align:center; font-size:0.8rem; margin-top:5px;">Equil√≠brio: <strong>${nashOld}</strong></div>
                </div>

                <div style="text-align:center; font-size:1.5rem; color:#CBD5E0;">‚ûî</div>

                <div>
                    <h6 style="text-align:center; color:#48BB78; margin-bottom:5px;">P√≥s-Implementa√ß√£o</h6>
                    ${generateMiniMatrix(gameNew, pA, pB)}
                    <div style="text-align:center; font-size:0.8rem; margin-top:5px;">Equil√≠brio: <strong>${nashNew}</strong></div>
                </div>
            </div>
            
            <div style="margin-top:15px; background:#f7fafc; padding:10px; font-size:0.85rem; border-radius:4px;">
                <strong>Estrat√©gia Usada:</strong> ${item.strategy || "N√£o definida"}<br>
                <strong>Resultado no Round:</strong> ${item.result === 'success' ? 'Sucesso (Cooperou)' : 'Falha (Resistiu)'}
            </div>
        `;
        targetDiv.appendChild(card);
    });
};

// --- NOVAS FUN√á√ïES AUXILIARES PARA AUDITORIA ---

function simulateOriginalGame(pA, pB, contextId) {
    // Reutiliza a l√≥gica ajustada para recriar o cen√°rio base
    const profA = globalPlayerProfiles[pA] || { interestScore: 0 };
    const profB = globalPlayerProfiles[pB] || { interestScore: 0 };
    
    // Recalcula Interesse Normalizado (Simplificado)
    let maxInterest = 15; // Valor m√©dio fixo para evitar rec√°lculo global pesado
    const intA = Math.ceil(((profA.interestScore||0) / maxInterest) * 5) || 1;
    const intB = Math.ceil(((profB.interestScore||0) / maxInterest) * 5) || 1;
    
    // In√©rcia = Interesse Negativo (L√≥gica nova)
    const ddA = -1 * intA;
    const ddB = -1 * intB;
    
    // Valores Base (estimativa para reconstru√ß√£o)
    return {
        CC: { A: intA, B: intB }, // Coopera√ß√£o baseada no interesse
        CD: { A: -3, B: 4 },      // Risco padr√£o
        DC: { A: 4, B: -3 },      // Tenta√ß√£o padr√£o
        DD: { A: ddA, B: ddB }    // In√©rcia ajustada
    };
}

function getNashState(g) {
    const isCC = (g.CC.A > g.DC.A) && (g.CC.B > g.CD.B);
    const isDD = (g.DD.A > g.CD.A) && (g.DD.B > g.DC.B);
    if (isCC && isDD) return "CC + DD (Risco)";
    if (isCC) return "CC (Coopera√ß√£o)";
    if (isDD) return "DD (Travamento)";
    return "Inst√°vel/Assim√©trico";
}

function generateMiniMatrix(game, pA, pB) {
    const isCC = (game.CC.A > game.DC.A) && (game.CC.B > game.CD.B);
    const isDD = (game.DD.A > game.CD.A) && (game.DD.B > game.DC.B);
    
    return `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px; background:#ccc; border:1px solid #ccc; font-size:0.75rem;">
        <div style="background:${isCC?'#C6F6D5':'white'}; padding:5px; text-align:center;">${game.CC.A},${game.CC.B}</div>
        <div style="background:white; padding:5px; text-align:center;">${game.CD.A},${game.CD.B}</div>
        <div style="background:white; padding:5px; text-align:center;">${game.DC.A},${game.DC.B}</div>
        <div style="background:${isDD?'#FED7D7':'white'}; padding:5px; text-align:center;">${game.DD.A},${game.DD.B}</div>
    </div>`;
}
});
    </script>
</body>
</html>